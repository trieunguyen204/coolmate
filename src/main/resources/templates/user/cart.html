<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Giỏ hàng của bạn - COOLMATE</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
         box-sizing: border-box;
         font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
         background: #f8f9fa;
         min-height: 100vh;
         padding-top: 60px;
     }


         .search-form {
         position: relative; /* Quan trọng: Để làm mốc tọa độ cho nút search bên trong */
     }

     .search-input {
         border-radius: 20px; /* Bo tròn ô tìm kiếm */
         padding-right: 40px; /* Chừa khoảng trống bên phải để chữ không bị nút search che mất */
         padding-left: 15px;
         border: none;
         background: rgba(255, 255, 255, 0.2); /* Nền trắng mờ (trong suốt 20%) */
         color: white; /* Chữ màu trắng */
         transition: all 0.3s; /* Hiệu ứng chuyển động mượt */
     }

     .search-input::placeholder {
         color: rgba(255, 255, 255, 0.7); /* Màu chữ gợi ý (placeholder) trắng mờ */
     }

     /* Trạng thái khi người dùng nhấn vào ô input */
     .search-input:focus {
         background: white; /* Nền chuyển sang trắng hẳn */
         color: #1E2C3D; /* Chữ chuyển sang màu xanh navy đậm */
         box-shadow: none;
     }

     .search-button {
         position: absolute; /* Định vị tuyệt đối để nằm đè lên input */
         right: 0; /* Căn sát lề phải */
         top: 50%; /* Căn giữa theo chiều dọc */
         transform: translateY(-50%); /* Căn chỉnh chính xác giữa tâm */
         background: none; /* Xóa nền mặc định của button */
         border: none; /* Xóa viền */
         color: rgba(255, 255, 255, 0.8); /* Màu icon trắng mờ */
         padding-right: 15px;
         transition: color 0.3s;
     }

     /* Khi input được focus, đổi màu icon nút tìm kiếm sang xanh navy */
     .search-input:focus ~ .search-button {
         color: #1E2C3D;
     }



     /* --- Navbar Styles (Đồng bộ home.html) --- */
     .navbar {
         background-color: #1E2C3D;
         box-shadow: 0 2px 10px rgba(0,0,0,0.15);
         z-index: 1030;
     }
     .navbar-brand {
         font-weight: 700;
         font-size: 1.5rem;
         color: white !important;
     }
     .nav-link {
         color: rgba(255, 255, 255, 0.8) !important;
         font-weight: 500;
         transition: color 0.3s ease;
         margin: 0 5px;
         padding: 10px 15px !important;
         border-radius: 5px;
     }
     .nav-link:hover, .nav-link.active {
         color: white !important;
         background-color: rgba(255, 255, 255, 0.1);
     }

     .action-icon { color: white; font-size: 1.2rem; margin-left: 15px; transition: color 0.3s; }
     .action-icon:hover { color: #ffc107; }

 /* Hiệu ứng khi di chuột vào icon */
 .action-icon:hover {
     color: #ffc107; /* Chuyển sang màu vàng nổi bật */
 }
     .cart-title {
         color: #1E2C3D;
         font-weight: 700;
     }

     .cart-item-card {
         background: white;
         border-radius: 12px;
         box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
         margin-bottom: 20px;
     }

     .product-image {
         width: 100%;
         height: 120px;
         object-fit: contain;
         border-radius: 8px;
         background: #f8f9fa;
     }

     .product-name {
         font-size: 1.1rem;
         font-weight: 600;
         color: #1E2C3D;
     }

     .price-text {
         color: #dc3545;
         font-weight: bold;
     }

     .quantity-control {
         display: flex;
         align-items: center;
     }

     .quantity-control button {
         width: 35px;
         height: 35px;
         border-radius: 5px;
         background: #eee;
         border: 1px solid #ccc;
         font-weight: bold;
         color: #1E2C3D;
     }

     .quantity-control input {
         width: 50px;
         text-align: center;
         border: 1px solid #ccc;
         margin: 0 5px;
         height: 35px;
         border-radius: 5px;
     }

     .summary-card {
         background: white;
         border-radius: 12px;
         box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
         padding: 25px;
         position: sticky;
         top: 80px;
     }

     .btn-checkout {
         background-color: #1E2C3D;
         border-color: #1E2C3D;
         color: white;
         padding: 12px;
         font-weight: 700;
         border-radius: 8px;
         transition: background-color 0.3s;
     }

     .btn-checkout:hover {
         background-color: #0d1a25;
         border-color: #0d1a25;
         color: white;
     }

     .empty-cart-message {
         text-align: center;
         padding: 50px;
         background: white;
         border-radius: 12px;
         box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
     }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark fixed-top">
    <div class="container-fluid container">
        <a class="navbar-brand" th:href="@{/}" href="#">COOLMATE</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"><span class="navbar-toggler-icon"></span></button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                <li class="nav-item"><a class="nav-link" th:href="@{/}" href="home.html">Trang chủ</a></li>
                <li class="nav-item"><a class="nav-link" th:href="@{/user/product}" href="product.html">Sản phẩm</a></li>
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" id="navbarDropdown" role="button"
                       data-bs-toggle="dropdown" aria-expanded="false">
                        Danh mục
                    </a>

                    <ul class="dropdown-menu" aria-labelledby="navbarDropdown">
                        <li th:each="c : ${categories}">
                            <a class="dropdown-item"
                               th:href="@{/products/by-category/{id}(id=${c.id})}"
                               th:text="${c.name}">
                            </a>
                        </li>
                    </ul>
                </li>
                <li class="nav-item"><a class="nav-link " th:href="@{/user/about}" href="#">Giới thiệu</a></li>
                <li class="nav-item"><a class="nav-link" th:href="@{/user/contact}" href="contact.html">Liên hệ</a></li>
            </ul>

            <form class="d-flex search-form me-3" role="search" th:action="@{/user/product}" method="get">
                <input class="form-control search-input" type="search"
                       placeholder="Tìm kiếm sản phẩm..."
                       aria-label="Search"
                       name="keyword"
                       th:value="${keyword}"> <button class="search-button" type="submit">
                <i class="fas fa-search"></i>
            </button>
            </form>


            <div class="d-flex align-items-center">
                <th:block th:if="${#authorization.expression('!isAuthenticated()')}">
                    <a th:href="@{/login}" class="action-icon" title="Đăng nhập/Đăng ký">
                        <i class="fas fa-user"></i>
                    </a>
                </th:block>
                <th:block th:if="${#authorization.expression('isAuthenticated()')}">
                    <div class="dropdown">
                        <a href="#" class="action-icon dropdown-toggle" id="userMenuDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-user-circle"></i>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userMenuDropdown">
                            <li><a class="dropdown-item" th:href="@{/user/profile}"><i class="fas fa-user me-2"></i>Tài khoản của tôi</a></li>
                            <li><a class="dropdown-item" th:href="@{/user/my_orders}"><i class="fas fa-box me-2"></i>Đơn hàng</a></li>
                            <li><hr class="dropdown-divider"></li>

                            <li>
                                <form th:action="@{/logout}" method="post" style="display: block;">
                                    <input type="hidden"
                                           th:name="${_csrf.parameterName}"
                                           th:value="${_csrf.token}" />
                                    <button type="submit" class="dropdown-item"
                                            style="width: 100%; text-align: left;">
                                        <i class="fas fa-sign-out-alt me-2"></i>Đăng xuất
                                    </button>
                                </form>
                            </li>
                        </ul>
                    </div>
                </th:block>

                <a th:href="@{/user/cart}" class="action-icon position-relative ms-3" title="Giỏ hàng">
                    <i class="fas fa-shopping-bag"></i>
                    <span id="cartCount" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" th:text="${cartItemCount}">
                            0
                            <span class="visually-hidden">sản phẩm trong giỏ</span>
                        </span>
                </a>
            </div>
        </div>
    </div>
</nav>


<div class="container my-4">
    <h1 class="cart-title mb-4">
        <i class="fas fa-shopping-bag me-2"></i> Giỏ hàng của bạn
    </h1>

    <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show" role="alert">
        <span th:text="${successMessage}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show" role="alert">
        <span th:text="${errorMessage}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>


    <div class="row">
        <div class="col-lg-8">
            <div th:if="${cart == null || cart.cartItems.isEmpty()}" class="empty-cart-message">
                <i class="fas fa-shopping-bag fa-3x mb-3" style="color: #adb5bd;"></i>
                <h4 class="mb-3">Giỏ hàng của bạn đang trống</h4>
                <p class="text-muted">Hãy thêm các sản phẩm thời trang yêu thích vào giỏ hàng ngay!</p>
                <a th:href="@{/}" class="btn btn-checkout mt-3">
                    <i class="fas fa-tshirt me-2"></i> Khám phá sản phẩm
                </a>
            </div>

            <div th:each="item : ${cart.cartItems}" class="cart-item-card p-3 d-flex align-items-center">
                <div class="row w-100 align-items-center g-3">
                    <div class="col-md-2 col-4">
                        <img th:src="${!item.productVariant.product.images.isEmpty() ? item.productVariant.product.images[0].imageUrl : '/images/placeholder.jpg'}"
                             class="product-image" alt="Product Image">
                    </div>
                    <div class="col-md-4 col-8">
                        <a th:href="@{/product/{id}(id=${item.productVariant.product.id})}"
                           class="text-decoration-none product-name"
                           th:text="${item.productVariant.product.name}">Tên SP</a>
                        <p class="mb-0 text-muted small">Mã: <span th:text="${item.productVariant.sku}">SKU</span></p>
                        <p class="mb-0 text-muted small">
                            Màu: <span th:text="${item.productVariant.color}"></span> |
                            Size: <span th:text="${item.productVariant.size.sizeName}"></span>
                        </p>
                    </div>
                    <div class="col-md-2 col-4 text-center">
                        <span class="price-text" th:text="${#numbers.formatDecimal(item.priceAtTime, 0, 'POINT', 0, 'COMMA')} + ' đ'">0 đ</span>
                    </div>
                    <div class="col-md-2 col-8">
                        <div class="quantity-control justify-content-center">
                            <form th:action="@{/user/cart/update-quantity}" method="post" style="display: inline;">
                                <input type="hidden" name="cartItemId" th:value="${item.id}" />
                                <input type="hidden" name="newQuantity" th:value="${item.quantity - 1}" />
                                <input type="hidden"
                                       th:name="${_csrf.parameterName}"
                                       th:value="${_csrf.token}" />
                                <button type="submit" class="btn btn-sm"
                                        th:disabled="${item.quantity <= 1}"
                                        style="width: 35px; height: 35px; padding: 0;">
                                    -
                                </button>
                            </form>

                            <input type="text"
                                   th:value="${item.quantity}"
                                   readonly
                                   class="form-control form-control-sm text-center"
                                   style="width: 50px; margin: 0 5px;">

                            <form th:action="@{/user/cart/update-quantity}" method="post" style="display: inline;">
                                <input type="hidden" name="cartItemId" th:value="${item.id}" />
                                <input type="hidden" name="newQuantity" th:value="${item.quantity + 1}" />
                                <input type="hidden"
                                       th:name="${_csrf.parameterName}"
                                       th:value="${_csrf.token}" />
                                <button type="submit" class="btn btn-sm"
                                        style="width: 35px; height: 35px; padding: 0;">
                                    +
                                </button>
                            </form>
                        </div>
                    </div>
                    <div class="col-md-1 col-6 text-center">
                         <span class="fw-bold text-danger"
                               th:text="${#numbers.formatDecimal(item.priceAtTime * item.quantity, 0, 'POINT', 0, 'COMMA')} + ' đ'">
                         </span>
                    </div>
                    <div class="col-md-1 col-6 text-end">
                        <a th:href="@{/user/cart/remove/{id}(id=${item.id})}" class="btn btn-sm btn-outline-danger">
                            <i class="fas fa-trash-alt"></i>
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4" th:if="${cart != null && !cart.cartItems.isEmpty()}">
            <div class="summary-card">
                <h4 class="fw-bold mb-3">Tóm tắt đơn hàng</h4>
                <div class="d-flex justify-content-between mb-2">
                    <span>Số lượng sản phẩm:</span>
                    <span th:text="${totalQuantity}">0</span>
                </div>
                <div class="d-flex justify-content-between mb-3 border-bottom pb-3">
                    <span>Phí vận chuyển:</span>
                    <span class="text-success fw-bold">Miễn phí</span>
                </div>
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h5 class="mb-0 fw-bold">Tổng cộng:</h5>
                    <h4 class="mb-0 text-danger fw-bold"
                        th:text="${#numbers.formatDecimal(grandTotal, 0, 'POINT', 0, 'COMMA')} + ' đ'">0 đ</h4>
                </div>

                <a th:href="@{/user/checkout}" class="btn btn-checkout w-100">
                    <i class="fas fa-credit-card me-2"></i> Tiến hành thanh toán
                </a>
                <a th:href="@{/user/product}" class="btn btn-outline-secondary w-100 mt-3">
                    <i class="fas fa-undo me-2"></i> Tiếp tục mua sắm
                </a>
            </div>
        </div>


    </div>
</div>



<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>

    // === GLOBAL VARIABLES & UTILS ===

    // Đổi key localStorage từ 'bookstoreCart' sang 'coolmateCart'

    const CART_STORAGE_KEY = 'coolmateCart';



    function formatPrice(price) {

        return price.toLocaleString('vi-VN') + ' đ';

    }



    // === CART LOGIC ===

    let cart = [];



    function loadCartFromStorage() {

        try {

            const storedCart = localStorage.getItem(CART_STORAGE_KEY);

            cart = storedCart ? JSON.parse(storedCart) : [];

        } catch (e) {

            console.error("Lỗi khi tải giỏ hàng:", e);

            cart = [];

        }

    }



    function saveCartToStorage() {

        localStorage.setItem(CART_STORAGE_KEY, JSON.stringify(cart));

        updateCartBadge();

    }



    function updateQuantity(id, change) {

        const item = cart.find(i => i.id === id);

        if (item) {

            item.quantity += change;

            if (item.quantity < 1) {

                item.quantity = 1;

            }

            saveCartToStorage();

            renderCart();

        }

    }



    function removeItem(id) {

        cart = cart.filter(item => item.id !== id);

        saveCartToStorage();

        renderCart();

    }



    function calculateTotals() {

        let subTotal = 0;

        let totalItems = 0;

        cart.forEach(item => {

            subTotal += item.price * item.quantity;

            totalItems += item.quantity;

        });

        const shippingFee = 0; // Giả định miễn phí ship

        const grandTotal = subTotal + shippingFee;



        return { subTotal, totalItems, grandTotal };

    }



    function renderCart() {

        const container = document.getElementById('cartItemsContainer');

        const emptyMessage = document.getElementById('emptyCartMessage');

        const totals = calculateTotals();



        // Cập nhật thông tin tóm tắt

        document.getElementById('totalItemsSummary').textContent = totals.totalItems;

        document.getElementById('subTotalSummary').textContent = formatPrice(totals.subTotal);

        document.getElementById('grandTotalSummary').textContent = formatPrice(totals.grandTotal);

        document.getElementById('checkoutBtn').disabled = totals.totalItems === 0;



        if (cart.length === 0) {

            container.classList.add('d-none');

            emptyMessage.classList.remove('d-none');

            return;

        } else {

            container.classList.remove('d-none');

            emptyMessage.classList.add('d-none');

        }



        // Render các item

        container.innerHTML = cart.map(item => `

            <div class="cart-item-card p-3 d-flex align-items-center">

                <div class="row w-100 align-items-center g-3">

                    <div class="col-md-2 col-4">

                        <img src="${item.imageUrl || 'placeholder_product.jpg'}" class="product-image" alt="${item.name}">

                    </div>

                    <div class="col-md-4 col-8">

                        <a href="#" class="text-decoration-none product-name">${item.name}</a>

                        <p class="mb-0 text-muted small">Mã: SP${item.id}</p>

                        <p class="mb-0 text-muted small">Size: ${item.size || 'M'}</p>

                    </div>

                    <div class="col-md-2 col-4 text-center">

                        <span class="price-text">${formatPrice(item.price)}</span>

                    </div>

                    <div class="col-md-2 col-8">

                        <div class="quantity-control justify-content-center">

                            <button onclick="updateQuantity(${item.id}, -1)">-</button>

                            <input type="number" value="${item.quantity}" min="1" onchange="updateCustomQuantity(${item.id}, this.value)" class="form-control form-control-sm text-center">

                            <button onclick="updateQuantity(${item.id}, 1)">+</button>

                        </div>

                    </div>

                    <div class="col-md-1 col-6 text-center">

                        <span class="fw-bold text-danger">${formatPrice(item.price * item.quantity)}</span>

                    </div>

                    <div class="col-md-1 col-6 text-end">

                        <button class="btn btn-sm btn-outline-danger" onclick="removeItem(${item.id})">

                            <i class="fas fa-trash-alt"></i>

                        </button>

                    </div>

                </div>

            </div>

        `).join('');

    }



    // Cập nhật số lượng thủ công

    function updateCustomQuantity(id, value) {

        const newQuantity = parseInt(value);

        if (!isNaN(newQuantity) && newQuantity >= 1) {

            const item = cart.find(i => i.id === id);

            if (item) {

                item.quantity = newQuantity;

                saveCartToStorage();

                renderCart();

            }

        } else {

            // Đảm bảo input luôn hiển thị giá trị hợp lệ nếu người dùng nhập sai

            renderCart();

        }

    }





    // Logic cho Cart Badge trên Navbar (Giống updateCartBadge() ở trên)

    function updateCartBadge() {

        const cart = JSON.parse(localStorage.getItem(CART_STORAGE_KEY) || '[]');

        const cartCount = document.getElementById('cartCount');

        if (cartCount) {

            const totalItems = cart.reduce((sum, item) => sum + (item.quantity || 1), 0);

            cartCount.textContent = totalItems;

            cartCount.style.display = totalItems > 0 ? 'inline' : 'none';

        }

    }





    // === INITIALIZE ===

    document.addEventListener('DOMContentLoaded', () => {

        loadCartFromStorage();

        renderCart();

    });

</script>
</body>
</html>