<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${product != null ? product.name : 'Chi tiết sản phẩm'} + ' - CoolFashion'"></title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <style>
        body {
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8f9fa;
            min-height: 100vh;
            padding-top: 70px;
        }

        /* --- Navbar Styles --- */
        .navbar {
            background-color: #1E2C3D;
            box-shadow: 0 2px 10px rgba(0,0,0,0.15);
            z-index: 1030;
        }
        .navbar-brand {
            font-weight: 700;
            font-size: 1.5rem;
            color: white !important;
        }
        .nav-link {
            color: rgba(255, 255, 255, 0.8) !important;
            font-weight: 500;
            transition: color 0.3s ease;
            margin: 0 5px;
            padding: 10px 15px !important;
            border-radius: 5px;
        }
        .nav-link:hover, .nav-link.active {
            color: white !important;
            background-color: rgba(255, 255, 255, 0.1);
        }
        .action-icon {
            color: white;
            font-size: 1.2rem;
            margin-left: 15px;
            transition: color 0.3s;
        }
        .action-icon:hover { color: #ffc107; }

        /* --- Search Form --- */
        .search-form { position: relative; }
        .search-input {
            border-radius: 20px;
            padding-right: 40px;
            padding-left: 15px;
            border: none;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            transition: all 0.3s;
        }
        .search-input::placeholder { color: rgba(255, 255, 255, 0.7); }
        .search-input:focus {
            background: white;
            color: #1E2C3D;
            box-shadow: none;
        }
        .search-button {
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.8);
            padding-right: 15px;
            transition: color 0.3s;
        }
        .search-input:focus ~ .search-button { color: #1E2C3D; }

        /* --- Product Detail Styles --- */
        .product-detail-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
            padding: 30px;
        }
        .main-image-display {
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #eee;
            aspect-ratio: 1 / 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f8f9fa;
        }
        .main-image-display img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        .thumbnail-scroll {
            display: flex;
            overflow-x: auto;
            gap: 10px;
            padding-bottom: 10px;
            margin-top: 10px;
        }
        .thumbnail-scroll img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 5px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: border-color 0.2s;
        }
        .thumbnail-scroll img.active, .thumbnail-scroll img:hover {
            border-color: #1E2C3D;
        }

        .product-name {
            font-weight: 700;
            color: #1E2C3D;
            margin-bottom: 15px;
            font-size: 2.2rem;
        }
        .current-price {
            font-size: 2.5rem;
            font-weight: bold;
            color: #dc3545;
            margin-right: 15px;
        }
        .old-price {
            font-size: 1.3rem;
            color: #6c757d;
            text-decoration: line-through;
        }

        /* Variant Buttons */
        .color-swatch {
            display: inline-block;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid #ddd;
            cursor: pointer;
            margin-right: 12px;
            margin-bottom: 10px;
            position: relative;
            transition: all 0.2s;
        }
        .color-swatch:hover { transform: scale(1.1); }
        .color-swatch.active {
            border-color: #1E2C3D;
            box-shadow: 0 0 0 3px rgba(30, 44, 61, 0.2);
        }
        .color-swatch.active::after {
            content: '\f00c';
            font-family: "Font Awesome 6 Free";
            font-weight: 900;
            color: white;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 16px;
            text-shadow: 0 0 3px rgba(0,0,0,0.5);
        }
        .color-swatch.active[title="Trắng"]::after,
        .color-swatch.active[title="White"]::after {
            color: #1E2C3D; text-shadow: none;
        }

        .size-btn {
            min-width: 60px;
            padding: 8px 15px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
            text-align: center;
            font-weight: 600;
            transition: all 0.2s;
        }
        .size-btn:hover { border-color: #1E2C3D; color: #1E2C3D; }
        .size-btn.active { background-color: #1E2C3D; color: white; border-color: #1E2C3D; }

        .btn-add-to-cart {
            background-color: #1E2C3D;
            border-color: #1E2C3D;
            color: white;
            padding: 15px 30px;
            font-size: 1.1rem;
            font-weight: 600;
            transition: 0.3s;
        }
        .btn-add-to-cart:hover { background-color: #0d1a25; }
        .btn-add-to-cart:disabled {
            background-color: #6c757d;
            border-color: #6c757d;
            cursor: not-allowed;
        }

        /* --- Comment Section Styles --- */
        .comment-section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
            padding: 30px;
            margin-top: 30px;
        }

        .star-rating .fa-star {
            font-size: 1.5rem;
            color: #ccc;
            cursor: pointer;
            transition: color 0.2s;
        }

        .star-rating .fa-star.checked,
        .star-rating .fa-star:hover,
        .star-rating .fa-star:hover ~ .fa-star {
            color: #ffc107;
        }

        .comment-item {
            border-bottom: 1px solid #eee;
            padding: 15px 0;
        }

        .comment-item:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }

        .comment-header {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }

        .comment-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #1E2C3D;
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: 600;
            font-size: 1rem;
            margin-right: 10px;
        }

        .comment-user-info strong {
            font-size: 1rem;
        }

        .comment-rating .fa-star {
            color: #ffc107;
            font-size: 0.9rem;
        }

        /* Chatbox */
        .chatbox-wrapper {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1050;
        }
        .chatbox-toggler {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: #1E2C3D;
            color: white;
            border: none;
            font-size: 1.5rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark fixed-top">
    <div class="container-fluid container">
        <a class="navbar-brand" th:href="@{/}">COOLMATE</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                <li class="nav-item">
                    <a class="nav-link" th:href="@{/}">Trang chủ</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" th:href="@{/user/product}">Sản phẩm</a>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" id="navbarDropdown" role="button"
                       data-bs-toggle="dropdown" aria-expanded="false">
                        Danh mục
                    </a>
                    <ul class="dropdown-menu" aria-labelledby="navbarDropdown">
                        <li th:each="c : ${categories}">
                            <a class="dropdown-item"
                               th:href="@{/products/by-category/{id}(id=${c.id})}"
                               th:text="${c.name}">
                            </a>
                        </li>
                    </ul>
                </li>
                <li class="nav-item"><a class="nav-link" th:href="@{/user/about}">Giới thiệu</a></li>
                <li class="nav-item"><a class="nav-link" th:href="@{/user/contact}">Liên hệ</a></li>
            </ul>

            <form class="d-flex search-form me-3" role="search" th:action="@{/user/product}" method="get">
                <input class="form-control search-input" type="search"
                       placeholder="Tìm kiếm sản phẩm..."
                       aria-label="Search"
                       name="keyword"
                       th:value="${keyword}">
                <button class="search-button" type="submit">
                    <i class="fas fa-search"></i>
                </button>
            </form>

            <div class="d-flex align-items-center">
                <th:block th:if="${#authorization.expression('!isAuthenticated()')}">
                    <a th:href="@{/login}" class="action-icon" title="Đăng nhập/Đăng ký">
                        <i class="fas fa-user"></i>
                    </a>
                </th:block>
                <th:block th:if="${#authorization.expression('isAuthenticated()')}">
                    <div class="dropdown">
                        <a href="#" class="action-icon dropdown-toggle" id="userMenuDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-user-circle"></i>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userMenuDropdown">
                            <li><a class="dropdown-item" th:href="@{/user/profile}"><i class="fas fa-user me-2"></i>Tài khoản</a></li>
                            <li><a class="dropdown-item" th:href="@{/user/my_orders}"><i class="fas fa-box me-2"></i>Đơn hàng</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <form th:action="@{/logout}" method="post" style="display: block;">
                                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                                    <button type="submit" class="dropdown-item" style="width: 100%; text-align: left;">
                                        <i class="fas fa-sign-out-alt me-2"></i>Đăng xuất
                                    </button>
                                </form>
                            </li>
                        </ul>
                    </div>
                </th:block>

                <a th:href="@{/user/cart}" class="action-icon position-relative ms-3" title="Giỏ hàng">
                    <i class="fas fa-shopping-bag"></i>
                    <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger"
                          th:text="${cartItemCount != null ? cartItemCount : 0}">
                        0
                        <span class="visually-hidden">sản phẩm</span>
                    </span>
                </a>
            </div>
        </div>
    </div>
</nav>

<div class="container mt-5 pt-4 mb-5">
    <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="fas fa-check-circle me-2"></i>
        <span th:text="${successMessage}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>

    <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="fas fa-exclamation-circle me-2"></i>
        <span th:text="${errorMessage}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>

    <div th:if="${product == null}" class="alert alert-warning text-center">
        Sản phẩm không tồn tại. <a th:href="@{/user/product}">Quay lại danh sách</a>
    </div>

    <div th:if="${product != null}" class="row product-detail-card">
        <div class="col-lg-5 mb-4">
            <div class="main-image-display mb-3">
                <img id="mainProductImage"
                     th:src="${product.imageUrl != null ? product.imageUrl : '/images/placeholder_product.jpg'}"
                     th:alt="${product.name}"
                     onerror="this.src='/images/placeholder_product.jpg'">
            </div>
            <div class="thumbnail-scroll">
                <th:block th:if="${!product.existingImages.isEmpty()}" th:each="img, stat : ${product.existingImages}">
                    <img th:src="${img.imageUrl}"
                         th:class="${stat.index == 0 ? 'active' : ''}"
                         onclick="changeMainImage(this)">
                </th:block>
                <th:block th:if="${product.existingImages.isEmpty()}">
                    <img th:src="${product.imageUrl}" class="active" onclick="changeMainImage(this)">
                </th:block>
            </div>
        </div>

        <div class="col-lg-7">
            <h1 class="product-name" th:text="${product.name}">Tên sản phẩm</h1>

            <div class="mb-3 d-flex align-items-center">
                <div class="me-2">
                    <th:block th:with="ratingInt=${T(java.lang.Math).round(averageRating)}">
                        <i th:each="i : ${#numbers.sequence(1, 5)}"
                           th:class="${i <= ratingInt ? 'fas fa-star text-warning' : 'far fa-star text-warning'}">
                        </i>
                    </th:block>
                </div>
                <span class="text-muted ms-1">
                    (<span th:text="${#numbers.formatDecimal(averageRating, 0, 1)}">0.0</span>/5 sao -
                    <span th:text="${productComments != null ? productComments.size() : 0}">0</span> đánh giá)
                </span>
            </div>

            <div class="mb-4 p-3 rounded-3" style="background-color: #f0fdf4; border: 1px solid #dcfce7;">
                <span class="current-price" th:text="${#numbers.formatDecimal(product.currentPrice, 0, 'POINT', 0, 'COMMA')} + ' đ'"></span>
                <del class="old-price" th:if="${product.oldPrice != null}" th:text="${#numbers.formatDecimal(product.oldPrice, 0, 'POINT', 0, 'COMMA')} + ' đ'"></del>
                <span class="badge bg-danger ms-3" th:if="${product.discountPercent > 0}" th:text="'-' + ${product.discountPercent} + '%'"></span>
            </div>

            <form th:action="@{/user/cart/add}" method="post" id="addToCartForm">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

                <input type="hidden" name="productId" th:value="${product.id}">
                <input type="hidden" name="color" id="selectedColorInput" required>
                <input type="hidden" name="size" id="selectedSizeInput" required>

                <div class="mb-4">
                    <label class="d-block fw-bold mb-2">Màu sắc: <span id="displaySelectedColor" class="text-primary fw-normal">Chưa chọn</span></label>
                    <div id="colorContainer" class="d-flex flex-wrap"></div>
                </div>

                <div class="mb-4">
                    <label class="d-block fw-bold mb-2">Kích cỡ: <span id="displaySelectedSize" class="text-primary fw-normal">--</span></label>
                    <div id="sizeContainer" class="d-flex flex-wrap">
                        <span class="text-muted small fst-italic">Vui lòng chọn màu sắc trước</span>
                    </div>
                    <small id="stockMessage" class="text-danger mt-1 d-block fw-bold"></small>
                </div>

                <div class="mb-4">
                    <label class="d-block fw-bold mb-2">Số lượng:</label>
                    <div class="input-group" style="width: 140px;">
                        <button type="button" class="btn btn-outline-secondary" onclick="updateQty(-1)">-</button>
                        <input type="number" name="quantity" id="quantityInput" class="form-control text-center" value="1" min="1" readonly>
                        <button type="button" class="btn btn-outline-secondary" onclick="updateQty(1)">+</button>
                    </div>
                </div>

                <div class="d-grid gap-2 d-md-flex mt-4">
                    <button type="submit" class="btn btn-add-to-cart flex-fill" id="btnSubmitCart" disabled>
                        <i class="fas fa-shopping-cart me-2"></i> THÊM VÀO GIỎ
                    </button>
                    <button type="button" class="btn btn-outline-danger btn-buy-now flex-fill" id="btnBuyNow" disabled onclick="submitForCheckout()">
                        MUA NGAY
                    </button>
                </div>
            </form>
            <div class="mt-5 border-top pt-4">
                <h5 class="fw-bold mb-3"><i class="fas fa-info-circle me-2"></i>Thông tin chi tiết</h5>
                <p><strong>Chất liệu:</strong> <span th:text="${product.material}"></span></p>
                <p><strong>Danh mục:</strong> <span th:text="${product.categoryName}"></span></p>
                <div th:utext="${product.description}" class="text-muted"></div>
            </div>
        </div>
    </div>

    <div class="comment-section mt-5">
        <h3 class="fw-bold mb-4"><i class="fas fa-comments me-2"></i>Đánh giá và Bình luận</h3>

        <th:block th:if="${#authorization.expression('isAuthenticated()')}">
            <div class="p-3 mb-4 border rounded-3 bg-light">
                <h5 class="mb-3">Gửi đánh giá của bạn</h5>
                <form th:action="@{/user/comments/add}" method="post" id="commentForm">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                    <input type="hidden" name="productId" th:value="${product.id}">
                    <input type="hidden" name="rate" id="ratingInput" value="0" required>

                    <div class="mb-3">
                        <label for="ratingStars" class="form-label fw-bold">Đánh giá sao:</label>
                        <div id="ratingStars" class="star-rating d-flex flex-row-reverse justify-content-end">
                            <i class="far fa-star" data-rating="5"></i>
                            <i class="far fa-star" data-rating="4"></i>
                            <i class="far fa-star" data-rating="3"></i>
                            <i class="far fa-star" data-rating="2"></i>
                            <i class="far fa-star" data-rating="1"></i>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="commentContent" class="form-label fw-bold">Nội dung bình luận:</label>
                        <textarea class="form-control" name="content" id="commentContent" rows="3"
                                  placeholder="Viết đánh giá chi tiết của bạn..." required></textarea>
                    </div>

                    <div class="d-flex justify-content-end">
                        <button type="submit" class="btn btn-primary">Gửi Bình Luận</button>
                    </div>
                </form>
            </div>
        </th:block>
        <th:block th:unless="${#authorization.expression('isAuthenticated()')}">
            <div class="alert alert-info text-center">
                Vui lòng <a th:href="@{/login}" class="alert-link">Đăng nhập</a> để gửi bình luận và đánh giá sản phẩm.
            </div>
        </th:block>


        <h4 class="mb-3 mt-4">Tất cả đánh giá (<span th:text="${productComments != null ? productComments.size() : 0}">0</span>)</h4>

        <div th:if="${productComments == null || productComments.isEmpty()}" class="alert alert-warning text-center">
            Sản phẩm này chưa có bình luận nào. Hãy là người đầu tiên!
        </div>

        <div th:if="${productComments != null && !productComments.isEmpty()}">
            <div th:each="comment : ${productComments}" class="comment-item">
                <div class="comment-header">
                    <div class="comment-avatar" th:text="${#strings.substring(comment.user.username, 0, 1).toUpperCase()}">U</div>
                    <div class="comment-user-info">
                        <strong th:text="${comment.user.username}">Anonymous User</strong>
                        <div class="comment-rating">
                            <th:block th:with="ratingVal=${comment.rate != null ? comment.rate : 0}">
                                <i th:each="i : ${#numbers.sequence(1, 5)}"
                                   th:class="${i <= ratingVal ? 'fas fa-star' : 'far fa-star'}">
                                </i>
                            </th:block>
                        </div>
                    </div>
                </div>
                <p class="mb-1" th:text="${comment.content}">Nội dung bình luận</p>
                <small class="text-muted" th:text="${#dates.format(comment.createdAt, 'dd/MM/yyyy HH:mm')}">20/12/2025 10:30</small>
            </div>
        </div>

    </div>
</div>

<div class="chatbox-wrapper">
    <button class="chatbox-toggler"><i class="fas fa-comment-dots"></i></button>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script th:inline="javascript">
    /*
     * DỮ LIỆU BIẾN THỂ (VARIANTS)
     * Đã sửa mapping để khớp với ProductDTO.ProductSizeColorStockDTO
     */
    const allVariants = [
        /*[# th:each="v : ${product.productVariants}"]*/
        {
            "id": [[${v.variantId}]],      // Khớp với DTO
            "color": [[${v.color}]],       // Khớp với DTO
            "sizeName": [[${v.sizeName}]], // Khớp với DTO
            "stock": [[${v.stock}]]        // Khớp với DTO
        },
        /*[/]*/
    ];

    // -- Debug: In ra console để kiểm tra xem có dữ liệu không --
    console.log("Loaded Variants:", allVariants);

    // DOM Elements
    const colorContainer = document.getElementById('colorContainer');
    const sizeContainer = document.getElementById('sizeContainer');
    const colorInput = document.getElementById('selectedColorInput');
    const sizeInput = document.getElementById('selectedSizeInput');
    const displayColor = document.getElementById('displaySelectedColor');
    const displaySize = document.getElementById('displaySelectedSize');
    const stockMsg = document.getElementById('stockMessage');
    const btnSubmit = document.getElementById('btnSubmitCart');
    const btnBuyNow = document.getElementById('btnBuyNow');
    const addToCartForm = document.getElementById('addToCartForm');
    const quantityInput = document.getElementById('quantityInput');
    const ratingStars = document.getElementById('ratingStars');
    const ratingInput = document.getElementById('ratingInput');


    const uniqueColors = [...new Set(allVariants.map(v => v.color).filter(color => color))]; // Lọc các giá trị null/undefined

    // --- KHỞI TẠO MÀU SẮC KHI TẢI TRANG ---
    document.addEventListener("DOMContentLoaded", function() {
        if (uniqueColors.length > 0) {
            uniqueColors.forEach(color => {
                const swatch = document.createElement('span');
                swatch.className = 'color-swatch';
                swatch.style.backgroundColor = mapColorToHex(color);
                swatch.title = color;
                swatch.onclick = () => handleSelectColor(color, swatch);
                colorContainer.appendChild(swatch);
            });
        } else {
            colorContainer.innerHTML = '<span class="text-danger">Sản phẩm tạm hết hàng hoặc chưa cập nhật biến thể</span>';
        }

        // Khởi tạo Rating Stars
        if (ratingStars) {
            ratingStars.querySelectorAll('.fa-star').forEach(star => {
                star.addEventListener('click', function() {
                    const rating = this.getAttribute('data-rating');
                    setRating(parseInt(rating));
                });
                star.addEventListener('mouseover', function() {
                    hoverRating(this.getAttribute('data-rating'));
                });
                star.addEventListener('mouseout', function() {
                    // Trở về trạng thái đã chọn khi rời chuột
                    setRating(parseInt(ratingInput.value), true);
                });
            });

            // Đặt lại trạng thái ban đầu (0 sao)
            setRating(0);
        }
    });

    // --- LOGIC ĐÁNH GIÁ SAO (JS) ---
    function setRating(rating, preserveHover = false) {
        if(!preserveHover) {
            ratingInput.value = rating;
        }

        const stars = ratingStars.querySelectorAll('.fa-star');
        stars.forEach(star => {
            const starRating = parseInt(star.getAttribute('data-rating'));
            if (starRating <= rating) {
                star.classList.remove('far');
                star.classList.add('fas', 'checked');
            } else {
                star.classList.remove('fas', 'checked');
                star.classList.add('far');
            }
        });
    }

    function hoverRating(hoveredRating) {
        const stars = ratingStars.querySelectorAll('.fa-star');
        stars.forEach(star => {
            const starRating = parseInt(star.getAttribute('data-rating'));
            if (starRating <= hoveredRating) {
                star.style.color = '#ffc107'; // Màu khi hover
            } else {
                star.style.color = '#ccc'; // Màu không được hover
            }
        });
    }

    // --- HÀM XỬ LÝ MÀU (Tiếng Việt -> HEX) ---
    function mapColorToHex(colorName) {
        if (!colorName) return '#ccc';
        const lower = colorName.toLowerCase().trim();

        if (lower.includes('đen') || lower.includes('black')) return '#000000';
        if (lower.includes('trắng') || lower.includes('white')) return '#ffffff';
        if (lower.includes('nâu') || lower.includes('brown') || lower.includes('cà phê')) return '#8B4513';
        if (lower.includes('xám') || lower.includes('ghi') || lower.includes('gray') || lower.includes('grey')) return '#808080';
        if (lower.includes('navy') || lower.includes('than')) return '#000080';
        if (lower.includes('xanh dương') || lower.includes('blue') || lower.includes('da trời')) return '#2196F3';
        if (lower.includes('xanh lá') || lower.includes('green') || lower.includes('rêu')) return '#4CAF50';
        if (lower.includes('olive')) return '#808000';
        if (lower.includes('xanh')) return '#2196F3';
        if (lower.includes('đỏ') || lower.includes('red') || lower.includes('đô')) return '#F44336';
        if (lower.includes('vàng') || lower.includes('yellow')) return '#FFEB3B';
        if (lower.includes('cam') || lower.includes('orange')) return '#FF9800';
        if (lower.includes('hồng') || lower.includes('pink')) return '#FFC0CB';
        if (lower.includes('tím') || lower.includes('purple')) return '#9C27B0';
        if (lower.includes('be') || lower.includes('beige')) return '#F5F5DC';
        if (lower.includes('kem') || lower.includes('cream')) return '#FFFDD0';
        if (lower.includes('nude')) return '#E3BC9A';
        if (lower.startsWith('#')) return lower;

        return '#cccccc'; // Mặc định
    }

    // --- LOGIC CHỌN MÀU ---
    function handleSelectColor(color, element) {
        // UI Updates
        document.querySelectorAll('.color-swatch').forEach(el => el.classList.remove('active'));
        element.classList.add('active');

        displayColor.textContent = color;
        colorInput.value = color;

        // Reset Size & Logic
        sizeInput.value = '';
        displaySize.textContent = '--';
        btnSubmit.disabled = true;
        btnBuyNow.disabled = true;
        stockMsg.textContent = '';
        quantityInput.value = 1;
        quantityInput.removeAttribute('max');

        // Filter available sizes for this color
        const availableSizes = allVariants.filter(v => v.color === color && v.stock > 0);
        renderSizes(availableSizes);
    }

    // --- LOGIC HIỂN THỊ SIZE ---
    function renderSizes(variants) {
        sizeContainer.innerHTML = '';
        if (variants.length === 0) {
            sizeContainer.innerHTML = '<span class="text-danger small">Hết hàng màu này</span>';
            return;
        }

        const sizeOrder = ['XS', 'S', 'M', 'L', 'XL', '2XL', 'XXL', '3XL'];
        variants.sort((a, b) => {
            let indexA = sizeOrder.indexOf(a.sizeName);
            let indexB = sizeOrder.indexOf(b.sizeName);
            if(indexA === -1) indexA = 99;
            if(indexB === -1) indexB = 99;
            return indexA - indexB;
        });

        variants.forEach(v => {
            const btn = document.createElement('div');
            btn.className = 'size-btn';
            btn.textContent = v.sizeName;
            btn.onclick = () => handleSelectSize(v, btn);
            sizeContainer.appendChild(btn);
        });
    }

    // --- LOGIC CHỌN SIZE ---
    function handleSelectSize(variant, element) {
        document.querySelectorAll('.size-btn').forEach(el => el.classList.remove('active'));
        element.classList.add('active');

        displaySize.textContent = variant.sizeName;
        sizeInput.value = variant.sizeName;

        stockMsg.textContent = `Còn lại: ${variant.stock} sản phẩm`;
        quantityInput.max = variant.stock;
        quantityInput.value = 1;

        btnSubmit.disabled = false;
        btnBuyNow.disabled = false;
    }

    // --- TĂNG GIẢM SỐ LƯỢNG ---
    function updateQty(change) {
        let val = parseInt(quantityInput.value) + change;
        let max = parseInt(quantityInput.max) || 999;

        if (val < 1) val = 1;
        if (val > max) {
            val = max;
            if (colorInput.value && sizeInput.value) {
                stockMsg.textContent = `Chỉ còn tối đa ${max} sản phẩm!`;
            }
        } else {
             if (colorInput.value && sizeInput.value) {
                 const currentVariant = allVariants.find(v => v.color === colorInput.value && v.sizeName === sizeInput.value);
                 if(currentVariant) stockMsg.textContent = `Còn lại: ${currentVariant.stock} sản phẩm`;
             }
        }
        quantityInput.value = val;
    }

    // --- ĐỔI ẢNH CHÍNH KHI CLICK THUMBNAIL ---
    function changeMainImage(element) {
        document.getElementById('mainProductImage').src = element.src;
        document.querySelectorAll('.thumbnail-scroll img').forEach(img => img.classList.remove('active'));
        element.classList.add('active');
    }

    // --- XỬ LÝ NÚT MUA NGAY ---
    // Nút này gọi đến CartController.java @PostMapping("/add-and-checkout")
    function submitForCheckout() {
        if (!colorInput.value || !sizeInput.value) {
            alert("Vui lòng chọn Màu sắc và Kích cỡ trước khi Mua Ngay.");
            return;
        }
        // Thay đổi action của form để gọi đến endpoint MUA NGAY
        addToCartForm.action = [[@{/user/cart/add-and-checkout}]];
        addToCartForm.submit();
    }
</script>

</body>
</html>