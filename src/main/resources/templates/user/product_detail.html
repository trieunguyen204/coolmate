<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${product != null ? product.name : 'Chi tiết sản phẩm'} + ' - CoolFashion'"></title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8f9fa;
            min-height: 100vh;
            padding-top: 60px;
        }


            .search-form {
            position: relative; /* Quan trọng: Để làm mốc tọa độ cho nút search bên trong */
        }

        .search-input {
            border-radius: 20px; /* Bo tròn ô tìm kiếm */
            padding-right: 40px; /* Chừa khoảng trống bên phải để chữ không bị nút search che mất */
            padding-left: 15px;
            border: none;
            background: rgba(255, 255, 255, 0.2); /* Nền trắng mờ (trong suốt 20%) */
            color: white; /* Chữ màu trắng */
            transition: all 0.3s; /* Hiệu ứng chuyển động mượt */
        }

        .search-input::placeholder {
            color: rgba(255, 255, 255, 0.7); /* Màu chữ gợi ý (placeholder) trắng mờ */
        }

        /* Trạng thái khi người dùng nhấn vào ô input */
        .search-input:focus {
            background: white; /* Nền chuyển sang trắng hẳn */
            color: #1E2C3D; /* Chữ chuyển sang màu xanh navy đậm */
            box-shadow: none;
        }

        .search-button {
            position: absolute; /* Định vị tuyệt đối để nằm đè lên input */
            right: 0; /* Căn sát lề phải */
            top: 50%; /* Căn giữa theo chiều dọc */
            transform: translateY(-50%); /* Căn chỉnh chính xác giữa tâm */
            background: none; /* Xóa nền mặc định của button */
            border: none; /* Xóa viền */
            color: rgba(255, 255, 255, 0.8); /* Màu icon trắng mờ */
            padding-right: 15px;
            transition: color 0.3s;
        }

        /* Khi input được focus, đổi màu icon nút tìm kiếm sang xanh navy */
        .search-input:focus ~ .search-button {
            color: #1E2C3D;
        }



        /* --- Navbar Styles (Đồng bộ home.html) --- */
        .navbar {
            background-color: #1E2C3D;
            box-shadow: 0 2px 10px rgba(0,0,0,0.15);
            z-index: 1030;
        }
        .navbar-brand {
            font-weight: 700;
            font-size: 1.5rem;
            color: white !important;
        }
        .nav-link {
            color: rgba(255, 255, 255, 0.8) !important;
            font-weight: 500;
            transition: color 0.3s ease;
            margin: 0 5px;
            padding: 10px 15px !important;
            border-radius: 5px;
        }
        .nav-link:hover, .nav-link.active {
            color: white !important;
            background-color: rgba(255, 255, 255, 0.1);
        }

        .action-icon { color: white; font-size: 1.2rem; margin-left: 15px; transition: color 0.3s; }
        .action-icon:hover { color: #ffc107; }





        /* --- PRODUCT DETAIL SPECIFIC STYLES --- */
        .product-detail-card {
            background: white; border-radius: 12px; box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08); padding: 30px;
        }

        /* Image Gallery */
        .main-image-display {
            border-radius: 8px; overflow: hidden; border: 1px solid #eee;
            aspect-ratio: 1 / 1; display: flex; align-items: center; justify-content: center; background: #f8f9fa;
        }
        .main-image-display img { width: 100%; height: 100%; object-fit: contain; }
        .thumbnail-scroll { display: flex; overflow-x: auto; gap: 10px; padding-bottom: 10px; margin-top: 10px; }
        .thumbnail-scroll img { width: 80px; height: 80px; object-fit: cover; border-radius: 5px; cursor: pointer; border: 2px solid transparent; transition: border-color 0.2s; }
        .thumbnail-scroll img.active, .thumbnail-scroll img:hover { border-color: #1E2C3D; }

        /* Product Info */
        .product-name { font-weight: 700; color: #1E2C3D; margin-bottom: 15px; font-size: 2.2rem; }
        .current-price { font-size: 2.5rem; font-weight: bold; color: #dc3545; margin-right: 15px; }
        .old-price { font-size: 1.3rem; color: #6c757d; text-decoration: line-through; }

        /* Variant Buttons */
        .color-swatch {
            display: inline-block; width: 40px; height: 40px; border-radius: 50%;
            border: 2px solid #ddd; cursor: pointer; margin-right: 12px; margin-bottom: 10px;
            position: relative; transition: all 0.2s;
        }
        .color-swatch:hover { transform: scale(1.1); }
        .color-swatch.active { border-color: #1E2C3D; box-shadow: 0 0 0 3px rgba(30, 44, 61, 0.2); }
        .color-swatch.active::after {
            content: '\f00c'; font-family: "Font Awesome 6 Free"; font-weight: 900;
            color: white; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 16px; text-shadow: 0 0 3px rgba(0,0,0,0.5);
        }

        .size-btn {
            min-width: 60px; padding: 8px 15px; border: 1px solid #ddd; background: white;
            border-radius: 6px; cursor: pointer; margin-right: 10px; margin-bottom: 10px;
            text-align: center; font-weight: 600; transition: all 0.2s;
        }
        .size-btn:hover { border-color: #1E2C3D; color: #1E2C3D; }
        .size-btn.active { background-color: #1E2C3D; color: white; border-color: #1E2C3D; }
        .size-btn.disabled { background-color: #f8f9fa; color: #ccc; border-color: #eee; cursor: not-allowed; }

        /* Actions */
        .btn-add-to-cart { background-color: #1E2C3D; border-color: #1E2C3D; color: white; padding: 15px 30px; font-size: 1.1rem; font-weight: 600; transition: 0.3s; }
        .btn-add-to-cart:hover { background-color: #0d1a25; }
        .btn-add-to-cart:disabled { background-color: #6c757d; border-color: #6c757d; cursor: not-allowed; }

        /* Chatbot */
        .chatbox-wrapper { position: fixed; bottom: 20px; right: 20px; z-index: 1050; }
        .chatbox-toggler { width: 60px; height: 60px; border-radius: 50%; background-color: #1E2C3D; color: white; border: none; font-size: 1.5rem; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark fixed-top">
    <div class="container-fluid container">
        <a class="navbar-brand" th:href="@{/}" href="#">COOLMATE</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                <li class="nav-item">
                    <a class="nav-link" th:href="@{/}" href="home.html">Trang chủ</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" th:href="@{/user/product}" href="#">Sản phẩm</a>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" id="navbarDropdown" role="button"
                       data-bs-toggle="dropdown" aria-expanded="false">
                        Danh mục
                    </a>

                    <ul class="dropdown-menu" aria-labelledby="navbarDropdown">
                        <li th:each="c : ${categories}">
                            <a class="dropdown-item"
                               th:href="@{/products/by-category/{id}(id=${c.id})}"
                               th:text="${c.name}">
                            </a>
                        </li>
                    </ul>
                </li>
                <li class="nav-item"><a class="nav-link" th:href="@{/user/about}" href="about.html">Giới thiệu</a></li>
                <li class="nav-item"><a class="nav-link" th:href="@{/user/contact}" href="contact.html">Liên hệ</a></li>
            </ul>

            <form class="d-flex search-form me-3" role="search" th:action="@{/user/product}" method="get">
                <input class="form-control search-input" type="search"
                       placeholder="Tìm kiếm sản phẩm..."
                       aria-label="Search"
                       name="keyword"
                       th:value="${keyword}"> <button class="search-button" type="submit">
                <i class="fas fa-search"></i>
            </button>
            </form>

            <div class="d-flex align-items-center">
                <th:block th:if="${#authorization.expression('!isAuthenticated()')}">
                    <a th:href="@{/login}" class="action-icon" title="Đăng nhập/Đăng ký">
                        <i class="fas fa-user"></i>
                    </a>
                </th:block>
                <th:block th:if="${#authorization.expression('isAuthenticated()')}">
                    <div class="dropdown">
                        <a href="#" class="action-icon dropdown-toggle" id="userMenuDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-user-circle"></i>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userMenuDropdown">
                            <li><a class="dropdown-item" th:href="@{/user/profile}"><i class="fas fa-user me-2"></i>Tài khoản của tôi</a></li>
                            <li><a class="dropdown-item" th:href="@{/user/my_orders}"><i class="fas fa-box me-2"></i>Đơn hàng</a></li>
                            <li><hr class="dropdown-divider"></li>

                            <li>
                                <form th:action="@{/logout}" method="post" style="display: block;">
                                    <input type="hidden"
                                           th:name="${_csrf.parameterName}"
                                           th:value="${_csrf.token}" />
                                    <button type="submit" class="dropdown-item"
                                            style="width: 100%; text-align: left;">
                                        <i class="fas fa-sign-out-alt me-2"></i>Đăng xuất
                                    </button>
                                </form>
                            </li>
                        </ul>
                    </div>
                </th:block>

                <a th:href="@{/user/cart}" class="action-icon position-relative ms-3" title="Giỏ hàng">
                    <i class="fas fa-shopping-bag"></i>
                    <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" th:text="${cartItemCount}">
                            0
                            <span class="visually-hidden">sản phẩm trong giỏ</span>
                        </span>
                </a>
            </div>
        </div>
    </div>
</nav>
<div class="container mt-5 pt-4 mb-5">

    <div th:if="${product == null}" class="alert alert-warning text-center">
        Sản phẩm không tồn tại. <a th:href="@{/user/product}">Quay lại danh sách</a>
    </div>

    <div th:if="${product != null}" class="row product-detail-card">

        <div class="col-lg-5 mb-4">
            <div class="main-image-display mb-3">
                <img id="mainProductImage"
                     th:src="${product.imageUrl != null ? product.imageUrl : '/images/placeholder_product.jpg'}"
                     th:alt="${product.name}"
                     onerror="this.src='/images/placeholder_product.jpg'">
            </div>
            <div class="thumbnail-scroll">
                <th:block th:if="${!product.existingImages.isEmpty()}" th:each="img, stat : ${product.existingImages}">
                    <img th:src="${img.imageUrl}"
                         th:class="${stat.index == 0 ? 'active' : ''}"
                         onclick="changeMainImage(this)">
                </th:block>
                <th:block th:if="${product.existingImages.isEmpty()}">
                    <img th:src="${product.imageUrl}" class="active">
                </th:block>
            </div>
        </div>

        <div class="col-lg-7">
            <h1 class="product-name" th:text="${product.name}">Tên sản phẩm</h1>

            <div class="mb-3">
                <i class="fas fa-star text-warning"></i>
                <i class="fas fa-star text-warning"></i>
                <i class="fas fa-star text-warning"></i>
                <i class="fas fa-star text-warning"></i>
                <i class="fas fa-star text-warning"></i>
                <span class="text-muted ms-2">(Đánh giá 5.0)</span>
            </div>

            <div class="mb-4 p-3 rounded-3" style="background-color: #f0fdf4; border: 1px solid #dcfce7;">
                <span class="current-price" th:text="${#numbers.formatDecimal(product.currentPrice, 0, 'POINT', 0, 'COMMA')} + ' đ'"></span>
                <del class="old-price" th:if="${product.oldPrice != null}" th:text="${#numbers.formatDecimal(product.oldPrice, 0, 'POINT', 0, 'COMMA')} + ' đ'"></del>
                <span class="badge bg-danger ms-3" th:if="${product.discountPercent > 0}" th:text="'-' + ${product.discountPercent} + '%'"></span>
            </div>

            <form th:action="@{/user/cart/add}" method="post" id="addToCartForm">
                <input type="hidden" name="productId" th:value="${product.id}">
                <input type="hidden" name="color" id="selectedColorInput" required>
                <input type="hidden" name="size" id="selectedSizeInput" required>

                <div class="mb-4">
                    <label class="d-block fw-bold mb-2">Màu sắc: <span id="displaySelectedColor" class="text-primary fw-normal">Chưa chọn</span></label>
                    <div id="colorContainer" class="d-flex flex-wrap">
                    </div>
                </div>

                <div class="mb-4">
                    <label class="d-block fw-bold mb-2">Kích cỡ: <span id="displaySelectedSize" class="text-primary fw-normal">--</span></label>
                    <div id="sizeContainer" class="d-flex flex-wrap">
                        <span class="text-muted small fst-italic">Vui lòng chọn màu sắc trước</span>
                    </div>
                    <small id="stockMessage" class="text-danger mt-1 d-block fw-bold"></small>
                </div>

                <div class="mb-4">
                    <label class="d-block fw-bold mb-2">Số lượng:</label>
                    <div class="input-group" style="width: 140px;">
                        <button type="button" class="btn btn-outline-secondary" onclick="updateQty(-1)">-</button>
                        <input type="number" name="quantity" id="quantityInput" class="form-control text-center" value="1" min="1" readonly>
                        <button type="button" class="btn btn-outline-secondary" onclick="updateQty(1)">+</button>
                    </div>
                </div>

                <div class="d-grid gap-2 d-md-flex mt-4">
                    <button type="submit" class="btn btn-add-to-cart flex-fill" id="btnSubmitCart" disabled>
                        <i class="fas fa-shopping-cart me-2"></i> THÊM VÀO GIỎ
                    </button>
                    <button type="button" class="btn btn-outline-danger btn-buy-now flex-fill" disabled>
                        MUA NGAY
                    </button>
                </div>
            </form>
            <div class="mt-5 border-top pt-4">
                <h5 class="fw-bold mb-3"><i class="fas fa-info-circle me-2"></i>Thông tin chi tiết</h5>
                <p><strong>Chất liệu:</strong> <span th:text="${product.material}"></span></p>
                <p><strong>Danh mục:</strong> <span th:text="${product.categoryName}"></span></p>
                <div th:utext="${product.description}" class="text-muted"></div>
            </div>
        </div>
    </div>
</div>

<div class="chatbox-wrapper">
    <button class="chatbox-toggler"><i class="fas fa-comment-dots"></i></button>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script th:inline="javascript">
    const allVariants = [[${product != null ? product.productVariants : '[]'}]];

    const colorContainer = document.getElementById('colorContainer');
    const sizeContainer = document.getElementById('sizeContainer');
    const colorInput = document.getElementById('selectedColorInput');
    const sizeInput = document.getElementById('selectedSizeInput');
    const displayColor = document.getElementById('displaySelectedColor');
    const displaySize = document.getElementById('displaySelectedSize');
    const stockMsg = document.getElementById('stockMessage');
    const btnSubmit = document.getElementById('btnSubmitCart');
    const btnBuyNow = document.querySelector('.btn-buy-now');

    const uniqueColors = [...new Set(allVariants.map(v => v.color))];

    if (uniqueColors.length > 0) {
        uniqueColors.forEach(color => {
            const swatch = document.createElement('span');
            swatch.className = 'color-swatch';
            swatch.style.backgroundColor = mapColorToHex(color);
            swatch.title = color; // Hiển thị tooltip tên màu khi hover
            swatch.onclick = () => handleSelectColor(color, swatch);
            colorContainer.appendChild(swatch);
        });
    } else {
        colorContainer.innerHTML = '<span class="text-danger">Sản phẩm tạm hết hàng</span>';
    }

    // --- HÀM XỬ LÝ MÀU NÂNG CAO (Tiếng Việt -> HEX) ---
    function mapColorToHex(colorName) {
        if (!colorName) return '#ccc';
        const lower = colorName.toLowerCase().trim();

        // 1. Kiểm tra các màu Đen/Trắng cơ bản
        if (lower.includes('đen') || lower.includes('black')) return '#000000';
        if (lower.includes('trắng') || lower.includes('white')) return '#ffffff';

        // 2. Nâu (Yêu cầu của bạn)
        if (lower.includes('nâu') || lower.includes('brown') || lower.includes('cà phê')) return '#8B4513';

        // 3. Xám/Ghi
        if (lower.includes('xám') || lower.includes('ghi') || lower.includes('gray') || lower.includes('grey')) return '#808080';

        // 4. Các tông Xanh
        if (lower.includes('navy') || lower.includes('than')) return '#000080'; // Xanh than
        if (lower.includes('xanh dương') || lower.includes('blue') || lower.includes('da trời')) return '#2196F3';
        if (lower.includes('xanh lá') || lower.includes('green') || lower.includes('rêu')) return '#4CAF50';
        if (lower.includes('olive')) return '#808000';
        if (lower.includes('xanh')) return '#2196F3'; // Mặc định cho chữ "xanh" đứng một mình

        // 5. Các màu nóng
        if (lower.includes('đỏ') || lower.includes('red') || lower.includes('đô')) return '#F44336';
        if (lower.includes('vàng') || lower.includes('yellow')) return '#FFEB3B';
        if (lower.includes('cam') || lower.includes('orange')) return '#FF9800';
        if (lower.includes('hồng') || lower.includes('pink')) return '#FFC0CB';
        if (lower.includes('tím') || lower.includes('purple')) return '#9C27B0';

        // 6. Màu trung tính khác
        if (lower.includes('be') || lower.includes('beige')) return '#F5F5DC';
        if (lower.includes('kem') || lower.includes('cream')) return '#FFFDD0';
        if (lower.includes('nude')) return '#E3BC9A';

        // 7. Nếu database lưu mã HEX (ví dụ #123456) -> trả về chính nó
        if (lower.startsWith('#')) return lower;

        return '#cccccc'; // Màu mặc định (xám nhạt) nếu không tìm thấy
    }

    function handleSelectColor(color, element) {
        document.querySelectorAll('.color-swatch').forEach(el => el.classList.remove('active'));
        element.classList.add('active');

        displayColor.textContent = color;
        colorInput.value = color;

        sizeInput.value = '';
        displaySize.textContent = '--';
        btnSubmit.disabled = true;
        btnBuyNow.disabled = true;
        stockMsg.textContent = '';

        const availableSizes = allVariants.filter(v => v.color === color && v.stock > 0);
        renderSizes(availableSizes);
    }

    function renderSizes(variants) {
        sizeContainer.innerHTML = '';
        if (variants.length === 0) {
            sizeContainer.innerHTML = '<span class="text-danger small">Hết hàng màu này</span>';
            return;
        }

        const sizeOrder = ['XS', 'S', 'M', 'L', 'XL', '2XL', '3XL', 'XXL'];
        variants.sort((a, b) => {
            return sizeOrder.indexOf(a.sizeName) - sizeOrder.indexOf(b.sizeName);
        });

        variants.forEach(v => {
            const btn = document.createElement('div');
            btn.className = 'size-btn';
            btn.textContent = v.sizeName;
            btn.onclick = () => handleSelectSize(v, btn);
            sizeContainer.appendChild(btn);
        });
    }

    function handleSelectSize(variant, element) {
        document.querySelectorAll('.size-btn').forEach(el => el.classList.remove('active'));
        element.classList.add('active');

        displaySize.textContent = variant.sizeName;
        sizeInput.value = variant.sizeName;
        stockMsg.textContent = `Còn lại: ${variant.stock} sản phẩm`;

        btnSubmit.disabled = false;
        btnBuyNow.disabled = false;
    }

    function updateQty(change) {
        const input = document.getElementById('quantityInput');
        let val = parseInt(input.value) + change;
        if (val < 1) val = 1;
        input.value = val;
    }

    function changeMainImage(element) {
        document.getElementById('mainProductImage').src = element.src;
        document.querySelectorAll('.thumbnail-scroll img').forEach(img => img.classList.remove('active'));
        element.classList.add('active');
    }
</script>

</body>
</html>