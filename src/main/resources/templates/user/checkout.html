<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thanh toán - COOLMATE</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Tông màu Coolmate: Xanh Navy/Đen (#1E2C3D) và Xám/Trắng */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f4f6f9;
            min-height: 100vh;
        }
        .container {
            margin-top: 40px;
            margin-bottom: 40px;
        }
        .checkout-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            padding: 30px;
        }
        .summary-card {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            border: 1px solid #e9ecef;
        }
        .section-title {
            color: #1E2C3D;
            font-weight: 700;
            border-bottom: 2px solid #1E2C3D;
            padding-bottom: 10px;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        .product-item {
            border-bottom: 1px solid #eee;
            padding: 10px 0;
        }
        .product-item:last-child {
            border-bottom: none;
        }

        .price-text {
            color: #dc3545;
            font-weight: bold;
        }

        .payment-method-label {
            cursor: pointer;
            border: 2px solid transparent;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            transition: all 0.3s;
            background: #ffffff;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: flex;
            align-items: center;
        }

        .payment-method-label:hover {
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        input[type="radio"]:checked + .payment-method-label {
            border-color: #1E2C3D; /* Màu Coolmate */
            background: #f0f3f6;
        }

        .payment-method-icon {
            font-size: 1.5rem;
            margin-right: 15px;
            color: #1E2C3D;
            width: 30px;
            text-align: center;
        }

        .btn-place-order {
            background-color: #1E2C3D;
            border-color: #1E2C3D;
            color: white;
            padding: 15px;
            font-size: 1.2rem;
            font-weight: 700;
            border-radius: 10px;
            transition: background-color 0.3s;
        }

        .btn-place-order:hover {
            background-color: #0d1a25;
            border-color: #0d1a25;
            color: white;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="row g-4">
        <div class="col-lg-7">
            <form th:action="@{/place-order}" method="post" id="checkoutForm">
                <input type="hidden" name="cartItemsJson" id="cartItemsJson">
                <input type="hidden" name="voucherCode" id="hiddenVoucherCode">

                <div class="checkout-card mb-4">
                    <h2 class="section-title"><i class="fas fa-map-marker-alt me-2"></i> Địa chỉ giao hàng</h2>
                    <div class="mb-3">
                        <label for="fullName" class="form-label fw-bold">Họ và tên *</label>
                        <input type="text" class="form-control" id="fullName" name="fullName" required
                               th:value="${defaultAddress.fullName}">
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="phone" class="form-label fw-bold">Số điện thoại *</label>
                            <input type="tel" class="form-control" id="phone" name="phone" required
                                   th:value="${defaultAddress.phone}">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="email" class="form-label fw-bold">Email (Tùy chọn)</label>
                            <input type="email" class="form-control" id="email" name="email"
                                   th:value="${defaultAddress.email}">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="addressDetail" class="form-label fw-bold">Địa chỉ chi tiết (Số nhà, Tên đường, Phường/Xã, Quận/Huyện, Tỉnh/Thành phố) *</label>
                        <textarea class="form-control" id="addressDetail" name="addressDetail" rows="3" required
                                  th:text="${defaultAddress.fullAddress}"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="orderNotes" class="form-label">Ghi chú cho đơn hàng (Tùy chọn)</label>
                        <textarea class="form-control" id="orderNotes" name="orderNotes" rows="2"></textarea>
                    </div>
                </div>

                <div class="checkout-card mb-4">
                    <h2 class="section-title"><i class="fas fa-money-check-alt me-2"></i> Phương thức thanh toán</h2>
                    <div id="paymentMethods">
                        <input type="radio" id="cod" name="paymentMethod" value="COD" class="d-none" required checked>
                        <label for="cod" class="payment-method-label">
                            <i class="fas fa-shipping-fast payment-method-icon"></i>
                            <div>
                                <h6 class="fw-bold mb-0">Thanh toán khi nhận hàng (COD)</h6>
                                <p class="mb-0 text-muted small">Kiểm tra và thanh toán trực tiếp cho shipper khi nhận sản phẩm.</p>
                            </div>
                        </label>

                        <input type="radio" id="bankTransfer" name="paymentMethod" value="BANK_TRANSFER" class="d-none" required>
                        <label for="bankTransfer" class="payment-method-label">
                            <i class="fas fa-university payment-method-icon"></i>
                            <div>
                                <h6 class="fw-bold mb-0">Chuyển khoản Ngân hàng</h6>
                                <p class="mb-0 text-muted small">Thanh toán qua ngân hàng (Coolmate sẽ gửi thông tin sau khi đặt hàng).</p>
                            </div>
                        </label>

                        <input type="radio" id="vnpay" name="paymentMethod" value="VNPAY" class="d-none" required>
                        <label for="vnpay" class="payment-method-label">
                            <i class="fas fa-qrcode payment-method-icon"></i>
                            <div>
                                <h6 class="fw-bold mb-0">Thanh toán qua VNPAY / Momo (Chuyển hướng)</h6>
                                <p class="mb-0 text-muted small">Thanh toán an toàn qua cổng VNPAY/Momo (cần tài khoản ngân hàng).</p>
                            </div>
                        </label>
                    </div>
                </div>

                <button type="submit" class="btn btn-place-order w-100" id="placeOrderBtn">
                    HOÀN TẤT ĐẶT HÀNG
                </button>
            </form>
        </div>

        <div class="col-lg-5">
            <div class="summary-card">
                <h2 class="section-title"><i class="fas fa-clipboard-list me-2"></i> Đơn hàng của bạn</h2>

                <div id="cartItemsSummary">
                </div>

                <div class="my-4 pt-3 border-top">
                    <label for="voucherCode" class="form-label fw-bold">Mã giảm giá (COOL20)</label>
                    <div class="input-group mb-2">
                        <input type="text" class="form-control" placeholder="Nhập mã voucher" id="voucherCodeInput">
                        <button class="btn btn-outline-secondary" type="button" id="applyVoucherBtn" style="color: #1E2C3D; border-color: #1E2C3D;">
                            Áp dụng
                        </button>
                    </div>
                    <div id="voucherMessage" class="small fst-italic"></div>
                </div>

                <div class="pt-3 border-top">
                    <div class="d-flex justify-content-between mb-2">
                        <span>Tạm tính hàng hóa (<span id="totalItemsSummary">0</span>):</span>
                        <span id="subTotalDisplay">0 đ</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Phí vận chuyển:</span>
                        <span class="text-success fw-bold">Miễn phí</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span class="text-primary fw-bold">Giảm giá Voucher:</span>
                        <span class="text-primary fw-bold" id="discountDisplay">- 0 đ</span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mt-3 border-top pt-3">
                        <h4 class="mb-0 fw-bold">TỔNG THANH TOÁN:</h4>
                        <h3 class="mb-0 text-danger fw-bold" id="grandTotalDisplay">0 đ</h3>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // === GLOBAL VARIABLES & UTILS ===
    const CART_STORAGE_KEY = 'coolmateCart'; // Đổi key
    const VOUCHER_STORAGE_CODE = 'appliedVoucherCode';
    const VOUCHER_STORAGE_AMOUNT = 'appliedDiscountAmount';

    let cart = [];
    let discount = 0;
    let subTotal = 0;
    let grandTotal = 0;
    let appliedVoucherCode = sessionStorage.getItem(VOUCHER_STORAGE_CODE) || '';

    function formatPrice(price) {
        return price.toLocaleString('vi-VN') + ' đ';
    }

    function loadCartFromSession() {
        try {
            const storedCart = localStorage.getItem(CART_STORAGE_KEY);
            cart = storedCart ? JSON.parse(storedCart) : [];
        } catch (e) {
            console.error("Lỗi khi tải giỏ hàng:", e);
            cart = [];
        }

        // Kiểm tra giỏ hàng trống và chặn thanh toán
        if (cart.length === 0) {
            document.getElementById('placeOrderBtn').disabled = true;
            alert('Giỏ hàng của bạn đang trống. Vui lòng quay lại trang chủ.');
            window.location.href = '/'; // Chuyển hướng về trang chủ
        }
    }

    function calculateTotals() {
        subTotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        grandTotal = subTotal - discount;
        if (grandTotal < 0) grandTotal = 0;

        const totalItems = cart.reduce((sum, item) => sum + (item.quantity || 1), 0);
        return { subTotal, totalItems, grandTotal };
    }

    function updateTotals() {
        const totals = calculateTotals();
        document.getElementById('totalItemsSummary').textContent = totals.totalItems;
        document.getElementById('subTotalDisplay').textContent = formatPrice(totals.subTotal);
        document.getElementById('discountDisplay').textContent = '- ' + formatPrice(discount);
        document.getElementById('grandTotalDisplay').textContent = formatPrice(totals.grandTotal);

        // Cập nhật giá trị ẩn cho form
        document.getElementById('cartItemsJson').value = JSON.stringify(cart);
    }

    function renderCartItemsSummary() {
        const container = document.getElementById('cartItemsSummary');
        container.innerHTML = cart.map(item => `
            <div class="d-flex justify-content-between product-item">
                <span class="text-muted small">${item.name} x ${item.quantity}</span>
                <span class="text-end fw-bold small">${formatPrice(item.price * item.quantity)}</span>
            </div>
        `).join('');
    }

    // === VOUCHER LOGIC ===
    function setupVoucherLogic() {
        const input = document.getElementById('voucherCodeInput');
        const applyBtn = document.getElementById('applyVoucherBtn');

        if (appliedVoucherCode) {
            input.value = appliedVoucherCode;
            discount = parseFloat(sessionStorage.getItem(VOUCHER_STORAGE_AMOUNT) || '0');
            displayVoucherMessage(`Mã ${appliedVoucherCode} đã được áp dụng.`, true);
        }

        applyBtn.addEventListener('click', () => {
            const code = input.value.trim().toUpperCase();
            if (code) {
                applyVoucher(code);
            } else {
                // Xóa mã cũ nếu có
                discount = 0;
                appliedVoucherCode = '';
                document.getElementById('hiddenVoucherCode').value = '';
                sessionStorage.removeItem(VOUCHER_STORAGE_CODE);
                sessionStorage.removeItem(VOUCHER_STORAGE_AMOUNT);
                displayVoucherMessage('Đã xóa mã giảm giá.', false);
                updateTotals();
            }
        });
    }

    // Mô phỏng API Voucher
    function applyVoucher(code) {
        // Giả lập logic kiểm tra mã giảm giá
        let result = {};
        if (code === 'COOL20') {
            const baseDiscount = calculateTotals().subTotal * 0.2; // 20%
            const maxDiscount = 100000; // Giới hạn 100k
            const discountAmount = Math.min(baseDiscount, maxDiscount);

            result = {
                success: true,
                discountAmount: discountAmount,
                message: 'Áp dụng mã COOL20 thành công!'
            };
        } else if (code === 'FREESHIP') {
            result = { success: true, discountAmount: 30000, message: 'Áp dụng Freeship thành công!' };
        } else {
            result = { success: false, message: 'Mã giảm giá không hợp lệ hoặc đã hết hạn.' };
        }

        handleVoucherResponse(code, result);
    }

    function displayVoucherMessage(message, isSuccess) {
        const messageDiv = document.getElementById('voucherMessage');
        messageDiv.textContent = message;
        messageDiv.style.color = isSuccess ? '#28a745' : '#dc3545';
    }

    function handleVoucherResponse(code, result) {
        if (result.success) {
            discount = result.discountAmount;
            appliedVoucherCode = code;
            document.getElementById('hiddenVoucherCode').value = code;
            sessionStorage.setItem(VOUCHER_STORAGE_CODE, code);
            sessionStorage.setItem(VOUCHER_STORAGE_AMOUNT, discount);
            displayVoucherMessage(result.message + ' (Giảm ' + formatPrice(discount) + ')', true);
        } else {
            discount = 0;
            appliedVoucherCode = '';
            document.getElementById('hiddenVoucherCode').value = '';
            sessionStorage.removeItem(VOUCHER_STORAGE_CODE);
            sessionStorage.removeItem(VOUCHER_STORAGE_AMOUNT);
            displayVoucherMessage(result.message || 'Mã không hợp lệ.', false);
        }
        updateTotals();
    }

    function setupPaymentUI() {
        // Không cần JS cho radio, chỉ cần CSS.
        // Tuy nhiên, có thể thêm logic để hiển thị thông tin thêm cho từng phương thức.
    }


    // === INIT ===
    document.addEventListener('DOMContentLoaded', () => {
        loadCartFromSession();
        renderCartItemsSummary();
        setupVoucherLogic();
        setupPaymentUI();
        updateTotals(); // Cập nhật lần cuối
    });
</script>

</body>
</html>