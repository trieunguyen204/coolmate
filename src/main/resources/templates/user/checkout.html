<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Thanh toán - COOLMATE</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background: #f4f6f9; font-family: 'Segoe UI', sans-serif; }
        .checkout-card, .summary-card { background: white; border-radius: 15px; padding: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .section-title { font-weight: 700; color: #1E2C3D; border-bottom: 2px solid #1E2C3D; padding-bottom: 10px; margin-bottom: 20px; }
        .btn-place-order { background-color: #1E2C3D; color: white; padding: 15px; font-weight: 700; width: 100%; border-radius: 8px; }
        .btn-place-order:hover { background-color: #0d1a25; }
        .product-item { border-bottom: 1px solid #eee; padding: 10px 0; }
        .address-select-box { background-color: #e9ecef; border-radius: 8px; padding: 15px; margin-bottom: 20px; border: 1px solid #ced4da; }
        /* Style cho Voucher */
        .voucher-item { cursor: pointer; transition: background 0.2s; border: 1px dashed #ccc; }
        .voucher-item:hover { background-color: #f8f9fa; border-color: #1E2C3D; }
    </style>
</head>
<body>

<div class="container my-5">

    <div th:if="${errorMessage}" class="alert alert-danger mb-4">
        <i class="fas fa-exclamation-triangle me-2"></i> <span th:text="${errorMessage}"></span>
    </div>

    <form th:action="@{/place-order}" method="post" id="checkoutForm">
        <input type="hidden" name="voucherCode" id="hiddenVoucherCode">

        <input type="hidden" name="discountAmount" id="hiddenDiscountAmount" value="0">


        <div class="row g-4">
            <div class="col-lg-7">
                <div class="checkout-card mb-4">
                    <h2 class="section-title"><i class="fas fa-map-marker-alt me-2"></i> Thông tin giao hàng</h2>

                    <div class="address-select-box" id="addressSelectBox"
                         th:if="${savedAddresses != null and !savedAddresses.isEmpty()}">
                        <label class="form-label fw-bold text-primary"><i class="fas fa-book me-2"></i>Chọn địa chỉ nhận hàng:</label>
                        <select class="form-select" id="addressSelector" onchange="fillAddressFromBook()">
                            <option value="" disabled selected>-- Vui lòng chọn địa chỉ --</option>
                            <option th:each="addr : ${savedAddresses}"
                                    th:value="${addr.id}"
                                    th:data-fullname="${addr.fullName}"
                                    th:data-phone="${addr.phone}"
                                    th:data-address="${addr.address}"
                                    th:text="${addr.fullName + ' - ' + addr.phone + ' - ' + addr.address}">
                            </option>
                            <option value="new">+ Nhập địa chỉ mới</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Họ và tên *</label>
                        <input type="text" class="form-control" name="fullName" id="inputFullName" required th:value="${userFullName}">
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Số điện thoại *</label>
                            <input type="tel" class="form-control" name="phone" id="inputPhone" required th:value="${userPhone}">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Email (Tùy chọn)</label>
                            <input type="email" class="form-control" name="email">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold" id="labelAddressDetail"
                               th:classappend="${savedAddresses != null and !savedAddresses.isEmpty()} ? 'd-none' : ''">
                            Địa chỉ nhận hàng chi tiết *
                        </label>
                        <textarea class="form-control" name="addressDetail" id="inputAddress" rows="3"
                                  placeholder="Số nhà, Đường, Phường/Xã, Quận/Huyện, Tỉnh/Thành..."
                                  required
                                  th:classappend="${savedAddresses != null and !savedAddresses.isEmpty()} ? 'd-none' : ''"></textarea>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Ghi chú (Tùy chọn)</label>
                        <textarea class="form-control" name="orderNotes" rows="2"></textarea>
                    </div>
                </div>

                <div class="checkout-card">
                    <h2 class="section-title"><i class="fas fa-wallet me-2"></i> Phương thức thanh toán</h2>
                    <div class="form-check p-3 border rounded mb-2">
                        <input class="form-check-input" type="radio" name="paymentMethod" id="cod" value="COD" checked>
                        <label class="form-check-label w-100" for="cod">
                            <span class="fw-bold"><i class="fas fa-truck text-primary me-2"></i>Thanh toán khi nhận hàng (COD)</span>
                        </label>
                    </div>
                    <div class="form-check p-3 border rounded">
                        <input class="form-check-input" type="radio" name="paymentMethod" id="bank" value="BANK_TRANSFER">
                        <label class="form-check-label w-100" for="bank">
                            <span class="fw-bold"><i class="fas fa-university text-success me-2"></i>Chuyển khoản ngân hàng</span>
                        </label>
                    </div>
                </div>
            </div>

            <div class="col-lg-5">
                <div class="summary-card">
                    <h2 class="section-title"><i class="fas fa-shopping-cart me-2"></i> Đơn hàng của bạn</h2>

                    <div class="cart-items-list mb-3 border-bottom pb-2">
                        <div th:each="item : ${cart.cartItems}" class="product-item d-flex justify-content-between">
                            <div>
                                <strong th:text="${item.productVariant.product.name}">Tên SP</strong>
                                <br>
                                <small class="text-muted">
                                    <span th:text="${item.productVariant.color}">Màu</span> /
                                    <span th:text="${item.productVariant.size.sizeName}">Size</span> x
                                    <span th:text="${item.quantity}">1</span>
                                </small>
                            </div>
                            <span class="fw-bold text-danger"
                                  th:text="${#numbers.formatDecimal(item.priceAtTime * item.quantity, 0, 'POINT', 0, 'COMMA')} + ' đ'">
                            </span>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="form-label fw-bold"><i class="fas fa-ticket-alt me-1"></i> Mã giảm giá</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="voucherCodeInput" placeholder="Nhập mã voucher">
                            <button class="btn btn-outline-secondary" type="button" onclick="checkVoucherOnServer()">Áp dụng</button>
                            <button class="btn btn-outline-danger" type="button" id="clearVoucherBtn" style="display: none;" onclick="clearVoucher()">Hủy</button>
                        </div>

                        <div class="text-end mt-1" th:if="${myVouchers != null and !myVouchers.isEmpty()}">
                            <a href="#" class="text-decoration-none small text-primary fw-bold" data-bs-toggle="modal" data-bs-target="#voucherModal">
                                Chọn mã ưu đãi của bạn
                            </a>
                        </div>

                        <small id="voucherMessage" class="d-block mt-1 fw-bold"></small>
                    </div>

                    <div class="pt-2">
                        <div class="d-flex justify-content-between mb-2">
                            <span>Tạm tính:</span>
                            <span id="subTotalDisplay" th:text="${#numbers.formatDecimal(total, 0, 'POINT', 0, 'COMMA')} + ' đ'">0 đ</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Phí vận chuyển:</span>
                            <span class="text-success fw-bold">Miễn phí</span>
                        </div>

                        <div class="d-flex justify-content-between mb-2 text-success" id="rowDiscount" style="display: none;">
                            <span>Giảm giá:</span>
                            <span class="fw-bold" id="discountDisplay">- 0 đ</span>
                        </div>

                        <div class="d-flex justify-content-between align-items-center mt-3 pt-3 border-top">
                            <h4 class="fw-bold">TỔNG CỘNG:</h4>
                            <h3 class="text-danger fw-bold" id="finalTotalDisplay" th:text="${#numbers.formatDecimal(total, 0, 'POINT', 0, 'COMMA')} + ' đ'">0 đ</h3>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-place-order mt-4">
                        HOÀN TẤT ĐẶT HÀNG
                    </button>
                    <a th:href="@{/user/cart}" class="d-block text-center mt-3 text-muted text-decoration-none">
                        <i class="fas fa-arrow-left"></i> Quay lại giỏ hàng
                    </a>
                </div>
            </div>
        </div>
    </form>
</div>

<div class="modal fade" id="voucherModal" tabindex="-1" aria-hidden="true" th:if="${myVouchers != null}">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content">
            <div class="modal-header bg-light py-2">
                <h6 class="modal-title fw-bold">Kho Voucher của bạn</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-2" style="max-height: 400px; overflow-y: auto;">
                <div class="list-group">
                    <div th:each="v : ${myVouchers}" class="list-group-item voucher-item p-3 mb-2 rounded"
                         th:onclick="selectVoucher([[${v.code}]])">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <span class="badge bg-danger mb-1" th:text="${v.code}">CODE</span>
                                <div class="small fw-bold text-dark">
                                    <span th:if="${v.discountType.name() == 'AMOUNT'}">Giảm <span th:text="${#numbers.formatDecimal(v.discountAmount, 0, 'POINT', 0, 'COMMA')}"></span>đ</span>
                                    <span th:if="${v.discountType.name() == 'PERCENT'}">Giảm <span th:text="${#numbers.formatDecimal(v.discountAmount, 0, 'POINT', 0, 'COMMA')}"></span>%</span>
                                </div>
                                <div class="text-muted" style="font-size: 0.7rem;">HSD: <span th:text="${#temporals.format(v.endDate, 'dd/MM/yyyy')}"></span></div>
                            </div>
                            <button class="btn btn-sm btn-outline-primary rounded-circle"><i class="fas fa-check"></i></button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script th:inline="javascript">
    // Lấy giá trị tổng tiền gốc từ Server (Thymeleaf)
    const originalTotal = [[${total}]];
    const formatNumber = (num) => new Intl.NumberFormat('vi-VN').format(num);

    // --- 1. JS ĐIỀN ĐỊA CHỈ (Code cũ) ---
    function fillAddressFromBook() {
        const selector = document.getElementById('addressSelector');
        if (!selector) return;
        const selectedOption = selector.options[selector.selectedIndex];
        const inputName = document.getElementById('inputFullName');
        const inputPhone = document.getElementById('inputPhone');
        const inputAddress = document.getElementById('inputAddress');
        const labelAddress = document.getElementById('labelAddressDetail');

        if (selector.value === "new") {
            inputAddress.classList.remove('d-none');
            labelAddress.classList.remove('d-none');
            inputAddress.value = "";
            inputName.value = "";
            inputPhone.value = "";
            inputName.focus();
            return;
        }
        inputAddress.classList.add('d-none');
        labelAddress.classList.add('d-none');
        if (selectedOption.getAttribute('data-fullname')) inputName.value = selectedOption.getAttribute('data-fullname');
        if (selectedOption.getAttribute('data-phone')) inputPhone.value = selectedOption.getAttribute('data-phone');
        if (selectedOption.getAttribute('data-address')) inputAddress.value = selectedOption.getAttribute('data-address');
    }

    document.addEventListener("DOMContentLoaded", function() {
        // Khởi tạo hiển thị tổng tiền ban đầu khi load trang
        updateTotalUI(0, 'AMOUNT');
        // Xử lý khi có lỗi từ RedirectAttributes
        const errorMessage = [[${errorMessage}]]
        if(errorMessage) {
            // Nếu có lỗi, đảm bảo các trường giá trị giảm giá reset
            document.getElementById('hiddenVoucherCode').value = "";
            document.getElementById('hiddenDiscountAmount').value = "0";
            updateTotalUI(0, 'AMOUNT');
        }
    });

    // --- 2. JS XỬ LÝ VOUCHER (MỚI) ---
    function selectVoucher(code) {
        document.getElementById('voucherCodeInput').value = code;
        const modalEl = document.getElementById('voucherModal');
        // Đảm bảo Modal được ẩn
        const modal = bootstrap.Modal.getInstance(modalEl);
        if (modal) modal.hide();

        checkVoucherOnServer(); // Tự động kiểm tra
    }

    // Thêm hàm hủy voucher
    function clearVoucher() {
        document.getElementById('voucherCodeInput').value = "";
        document.getElementById('hiddenVoucherCode').value = "";
        document.getElementById('hiddenDiscountAmount').value = "0";
        document.getElementById('voucherMessage').textContent = "Đã hủy áp dụng mã giảm giá.";
        document.getElementById('voucherMessage').className = "d-block mt-1 fw-bold text-muted";
        document.getElementById('clearVoucherBtn').style.display = 'none';
        updateTotalUI(0, 'AMOUNT');
    }

    function checkVoucherOnServer() {
        const code = document.getElementById('voucherCodeInput').value.trim();
        const msgDiv = document.getElementById('voucherMessage');
        const hiddenCodeInput = document.getElementById('hiddenVoucherCode');
        const hiddenDiscountInput = document.getElementById('hiddenDiscountAmount');
        const clearBtn = document.getElementById('clearVoucherBtn');

        if (!code) {
            msgDiv.textContent = "Vui lòng nhập mã giảm giá.";
            msgDiv.className = "d-block mt-1 fw-bold text-danger";
            hiddenCodeInput.value = "";
            hiddenDiscountInput.value = "0";
            clearBtn.style.display = 'none';
            updateTotalUI(0, 'AMOUNT');
            return;
        }

        // Gọi API check
        fetch(`/api/voucher/check?code=${code}&total=${originalTotal}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Thành công
                    msgDiv.textContent = data.message; // "Áp dụng thành công"
                    msgDiv.className = "d-block mt-1 fw-bold text-success";
                    hiddenCodeInput.value = data.code; // Lưu vào input ẩn để submit form
                    clearBtn.style.display = 'inline-block';

                    // SỬA: data.discountAmount là SỐ TIỀN giảm đã tính sẵn
                    const calculatedDiscountAmount = parseFloat(data.discountAmount);

                    hiddenDiscountInput.value = calculatedDiscountAmount;
                    updateTotalUI(calculatedDiscountAmount);

                } else {
                    // Thất bại
                    msgDiv.textContent = data.message; // "Mã không tồn tại/hết hạn"
                    msgDiv.className = "d-block mt-1 fw-bold text-danger";
                    hiddenCodeInput.value = ""; // Xóa mã sai
                    hiddenDiscountInput.value = "0";
                    clearBtn.style.display = 'none';
                    updateTotalUI(0);
                }
            })
            .catch(err => {
                console.error(err);
                msgDiv.textContent = "Lỗi hệ thống khi kiểm tra voucher.";
                msgDiv.className = "d-block mt-1 fw-bold text-danger";
                hiddenCodeInput.value = "";
                hiddenDiscountInput.value = "0";
                clearBtn.style.display = 'none';
                updateTotalUI(0);
            });
    }

    // Function tính toán và cập nhật UI (chỉ cần số tiền giảm tuyệt đối)
    function updateTotalUI(discountAmount) {
        const rowDiscount = document.getElementById('rowDiscount');
        const discountDisplay = document.getElementById('discountDisplay');
        const finalTotalDisplay = document.getElementById('finalTotalDisplay');
        const clearBtn = document.getElementById('clearVoucherBtn');

        if (discountAmount > 0) {
            rowDiscount.style.display = 'flex';
            discountDisplay.textContent = '- ' + formatNumber(discountAmount) + ' đ';

            const newTotal = originalTotal - discountAmount;
            finalTotalDisplay.textContent = formatNumber(newTotal > 0 ? newTotal : 0) + ' đ';
            clearBtn.style.display = 'inline-block';
        } else {
            rowDiscount.style.display = 'none';
            finalTotalDisplay.textContent = formatNumber(originalTotal) + ' đ';
            // Chỉ ẩn khi gọi từ clearVoucher hoặc lỗi
            if (document.getElementById('hiddenVoucherCode').value === "") {
                clearBtn.style.display = 'none';
            }
        }
    }
</script>
</body>
</html>