<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý Bình luận - Admin Coolmate</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* CSS CỦA COOLMATE ADMIN THEME */
         body {
             box-sizing: border-box;
             font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
             background: #f8f9fa;
             margin: 0;
             padding: 0;
         }

         /* Sidebar Styles - Màu Coolmate: Navy/Blue Grey */
         .sidebar {
             position: fixed;
             top: 0;
             left: 0;
             height: 100vh;
             width: 280px;
             background: linear-gradient(135deg, #1c3144 0%, #3e5a77 100%);
             color: white;
             transition: all 0.3s ease;
             z-index: 1000;
             overflow-y: auto;
         }

         .sidebar.collapsed { width: 80px; }

         .sidebar-header {
             padding: 25px 20px;
             border-bottom: 1px solid rgba(255, 255, 255, 0.1);
             display: flex;
             align-items: center;
             white-space: nowrap;
         }

         .sidebar-logo {
             font-size: 2rem;
             margin-right: 10px;
         }

         .sidebar.collapsed .sidebar-logo { margin: 0; }

         .sidebar-title {
             margin: 0;
             font-size: 1.5rem;
             font-weight: 600;
         }

         .sidebar.collapsed .sidebar-title { display: none; }

         .sidebar-menu { padding: 10px 0; }

         .menu-item {
             display: flex;
             align-items: center;
             padding: 15px 20px;
             color: white;
             text-decoration: none;
             transition: background 0.2s, border-left 0.2s;
             border-left: 4px solid transparent;
             font-weight: 500;
         }

         .menu-item:hover {
             background: rgba(255, 255, 255, 0.15);
             color: white;
         }

         .menu-item i {
             font-size: 1.1rem;
             width: 30px;
             text-align: center;
         }

         .sidebar.collapsed .menu-item span { display: none; }

         .sidebar.collapsed .menu-item { justify-content: center; }

         .menu-item.active {
             background: #3e5a77;
             border-left: 4px solid #f9fafb;
         }

         .toggle-btn {
             position: absolute;
             top: 20px;
             right: -40px;
             z-index: 1010;
             color: #1c3144;
             font-size: 1.2rem;
         }

         .sidebar.collapsed .toggle-btn { right: -50px; }

         .main-content { margin-left: 280px; transition: margin-left 0.3s ease; }
         .main-content.expanded { margin-left: 80px; }
         .header { background: white; padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 30px; }
         .dashboard-content { padding: 0 30px 30px; }

         /* Table Styles */
         .table-card { background: white; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.05); padding: 20px; }
         .comment-content { max-width: 300px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
         .rating-star { color: #ffc107; font-size: 0.8rem; }
    </style>
</head>
<body>

<div id="sidebar" class="sidebar">
    <button class="btn btn-link text-white toggle-btn d-none d-md-block" onclick="toggleSidebar()">
        <i class="fas fa-chevron-left" id="toggleIcon"></i>
    </button>
    <div class="sidebar-header">
        <div class="sidebar-logo">
            <i class="fas fa-shirt"></i>
        </div>
        <h2 class="sidebar-title">Coolmate</h2>
    </div>

    <nav class="sidebar-menu">
        <a th:href="@{/admin/home}" class="menu-item">
            <i class="fas fa-home"></i> <span>Trang chủ</span>
        </a>
        <a th:href="@{/admin/products}" class="menu-item">
            <i class="fas fa-box"></i> <span>Quản lý sản phẩm</span>
        </a>
        <a th:href="@{/admin/categories}" class="menu-item ">
            <i class="fas fa-list-alt"></i> <span>Quản lý danh mục</span>
        </a>
        <a th:href="@{/admin/sizes}" class="menu-item">
            <i class="fas fa-ruler-horizontal"></i> <span>Quản lý size</span>
        </a>
        <a th:href="@{/admin/orders}" class="menu-item">
            <i class="fas fa-shopping-cart"></i> <span>Quản lý đơn hàng</span>
        </a>
        <a th:href="@{/admin/users}" class="menu-item">
            <i class="fas fa-users"></i> <span>Quản lý khách hàng</span>
        </a>
        <a th:href="@{/admin/vouchers}" class="menu-item">
            <i class="fas fa-tag"></i> <span>Quản lý Voucher</span>
        </a>
        <a th:href="@{/admin/comments}" class="menu-item active">
            <i class="fas fa-comments"></i> <span>Quản lý bình luận</span>
        </a>

        <form th:action="@{/logout}" method="post" class="mt-3"
              style="width: 100%; padding: 0;">
            <input type="hidden"
                   th:name="${_csrf.parameterName}"
                   th:value="${_csrf.token}" />

            <button type="submit" class="menu-item"
                    style="width: 100%; border: none; background: transparent;
                           padding: 15px 20px; color: white; cursor: pointer;
                           transition: background 0.2s, border-left 0.2s;
                           font-weight: 500; display: flex; align-items: center;">
                <i class="fas fa-sign-out-alt" style="font-size: 1.1rem; width: 30px; text-align: center;"></i>
                <span>Đăng xuất</span>
            </button>
        </form>
    </nav>
</div>

<div id="mainContent" class="main-content">
    <div class="header">
        <h1 class="header-title fs-4">Quản lý Bình luận & Đánh giá</h1>
        <div><span class="text-muted small">Admin Panel</span></div>
    </div>

    <div class="dashboard-content">
        <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show">
            <i class="fas fa-check-circle me-2"></i><span th:text="${successMessage}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show">
            <i class="fas fa-exclamation-circle me-2"></i><span th:text="${errorMessage}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>

        <div class="table-card">
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead class="table-light">
                    <tr>
                        <th>ID</th>
                        <th>Người dùng</th>
                        <th>Sản phẩm</th>
                        <th>Đánh giá</th>
                        <th>Nội dung</th>
                        <th>Ngày tạo</th>
                        <th>Trạng thái</th>
                        <th>Hành động</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="c : ${comments}">
                        <td th:text="${c.id}">1</td>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="bg-secondary text-white rounded-circle d-flex justify-content-center align-items-center me-2" style="width:30px;height:30px;font-size:0.8rem">
                                    <span th:text="${#strings.substring(c.user.username,0,1).toUpperCase()}">U</span>
                                </div>
                                <span th:text="${c.user.username}" class="fw-bold text-dark">User</span>
                                <span th:if="${c.isAdminReply}" class="badge bg-primary ms-2" style="font-size: 0.6rem">Admin</span>
                            </div>
                        </td>
                        <td>
                            <a th:href="@{/product/{id}(id=${c.product.id})}" target="_blank" class="text-decoration-none">
                                <span th:text="${#strings.abbreviate(c.product.name, 30)}">Tên SP</span>
                                <i class="fas fa-external-link-alt small ms-1"></i>
                            </a>
                        </td>
                        <td>
                            <div th:if="${c.rate != null}">
                                <span th:text="${c.rate}">5</span> <i class="fas fa-star rating-star"></i>
                            </div>
                            <span th:if="${c.rate == null}" class="text-muted small">-</span>
                        </td>
                        <td>
                            <div class="comment-content" th:text="${c.content}" th:title="${c.content}">Nội dung...</div>
                            <small th:if="${c.parent != null}" class="text-muted d-block">
                                <i class="fas fa-reply me-1"></i>Trả lời cho ID: <span th:text="${c.parent.id}"></span>
                            </small>
                        </td>
                        <td th:text="${#dates.format(c.createdAt, 'dd/MM/yyyy HH:mm')}">Time</td>
                        <td>
                            <span th:if="${c.isAdminReply}" class="badge bg-info text-dark">Phản hồi</span>
                            <span th:unless="${c.isAdminReply}" class="badge bg-light text-dark border">User</span>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary me-1"
                                    th:if="${!c.isAdminReply}"
                                    th:onclick="openReplyModal([[${c.id}]], [[${c.user.username}]], [[${c.product.id}]])">
                                <i class="fas fa-reply"></i>
                            </button>

                        </td>
                    </tr>
                    <tr th:if="${comments.isEmpty()}">
                        <td colspan="8" class="text-center py-4 text-muted">Chưa có bình luận nào.</td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="replyModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form th:action="@{/admin/comments/reply}" method="post">
                <div class="modal-header">
                    <h5 class="modal-title">Trả lời bình luận</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="parentId" id="modalParentId">
                    <input type="hidden" name="productId" id="modalProductId"> <input type="hidden" name="redirectUrl" value="/admin/comments"> <p>Đang trả lời người dùng: <strong id="modalUserName" class="text-primary"></strong></p>

                    <div class="mb-3">
                        <label class="form-label">Nội dung phản hồi:</label>
                        <textarea name="content" class="form-control" rows="4" required placeholder="Nhập câu trả lời của bạn..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                    <button type="submit" class="btn btn-primary">Gửi Trả Lời</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    function openReplyModal(id, username, productId) {
        document.getElementById('modalParentId').value = id;
        document.getElementById('modalProductId').value = productId; // Set ProductId dù không redirect về đó
        document.getElementById('modalUserName').textContent = username;

        var myModal = new bootstrap.Modal(document.getElementById('replyModal'));
        myModal.show();
    }
</script>

</body>
</html>