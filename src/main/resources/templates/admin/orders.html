<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="${pageTitle}">Quản lý Đơn hàng - Coolmate</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* CSS CỦA COOLMATE ADMIN THEME */
 body {
     box-sizing: border-box;
     font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
     background: #f8f9fa;
     margin: 0;
     padding: 0;
 }

 /* Sidebar Styles - Màu Coolmate: Navy/Blue Grey */
 .sidebar {
     position: fixed;
     top: 0;
     left: 0;
     height: 100vh;
     width: 280px;
     background: linear-gradient(135deg, #1c3144 0%, #3e5a77 100%);
     color: white;
     transition: all 0.3s ease;
     z-index: 1000;
     overflow-y: auto;
 }

 .sidebar.collapsed { width: 80px; }

 .sidebar-header {
     padding: 25px 20px;
     border-bottom: 1px solid rgba(255, 255, 255, 0.1);
     display: flex;
     align-items: center;
     white-space: nowrap;
 }

 .sidebar-logo {
     font-size: 2rem;
     margin-right: 10px;
 }

 .sidebar.collapsed .sidebar-logo { margin: 0; }

 .sidebar-title {
     margin: 0;
     font-size: 1.5rem;
     font-weight: 600;
 }

 .sidebar.collapsed .sidebar-title { display: none; }

 .sidebar-menu { padding: 10px 0; }

 .menu-item {
     display: flex;
     align-items: center;
     padding: 15px 20px;
     color: white;
     text-decoration: none;
     transition: background 0.2s, border-left 0.2s;
     border-left: 4px solid transparent;
     font-weight: 500;
 }

 .menu-item:hover {
     background: rgba(255, 255, 255, 0.15);
     color: white;
 }

 .menu-item i {
     font-size: 1.1rem;
     width: 30px;
     text-align: center;
 }

 .sidebar.collapsed .menu-item span { display: none; }

 .sidebar.collapsed .menu-item { justify-content: center; }

 .menu-item.active {
     background: #3e5a77;
     border-left: 4px solid #f9fafb;
 }

 .toggle-btn {
     position: absolute;
     top: 20px;
     right: -40px;
     z-index: 1010;
     color: #1c3144;
     font-size: 1.2rem;
 }

 .sidebar.collapsed .toggle-btn { right: -50px; }

 /* CSS MỚI: Định vị main-content */
 .main-content {
     margin-left: 280px; /* Bằng chiều rộng mặc định của sidebar */
     padding: 20px;
     transition: margin-left 0.3s ease;
 }

 /* Điều chỉnh main-content khi sidebar được thu gọn */
 .sidebar.collapsed ~ .main-content {
     margin-left: 80px; /* Bằng chiều rộng thu gọn của sidebar */
 }

 /* Media Queries for Mobile (Chỉ phần liên quan đến sidebar và main-content) */
 @media (max-width: 768px) {
     .sidebar {
         left: -280px;
         width: 280px;
     }
     .sidebar.show { left: 0; }
     /*... các quy tắc khác được loại bỏ để chỉ giữ lại sidebar*/
     .sidebar.collapsed { width: 280px; }
     .sidebar.collapsed .sidebar-title, .sidebar.collapsed .menu-item span { display: block; }
     .sidebar.collapsed .menu-item { justify-content: flex-start; }

     .main-content {
         margin-left: 0; /* Trên di động, main-content chiếm toàn bộ, sidebar ẩn */
     }
 }

         .badge-status { font-size: 0.85rem; padding: 5px 10px; }
         .bg-pending { background-color: #fff3cd; color: #856404; }
         .bg-processing { background-color: #d1ecf1; color: #0c5460; }
         .bg-shipped { background-color: #add8e6; color: #000080; } /* Blue/Navy */
         .bg-delivered { background-color: #d4edda; color: #155724; }
         .bg-cancelled { background-color: #f8d7da; color: #721c24; }
         .bg-secondary { background-color: #6c757d; color: white; } /* Default fallback */

         .product-thumb-small { width: 40px; height: 40px; object-fit: cover; border-radius: 4px; margin-right: 10px; }
         .modal-body { max-height: 80vh; overflow-y: auto; }

         /* CSS CHO STEP PROGRESS ĐÃ ĐƯỢC XÓA */
    </style>
</head>
<body>



<div id="sidebar" class="sidebar">
    <button class="btn btn-link text-white toggle-btn d-none d-md-block" onclick="toggleSidebar()">
        <i class="fas fa-chevron-left" id="toggleIcon"></i>
    </button>
    <div class="sidebar-header">
        <div class="sidebar-logo">
            <i class="fas fa-shirt"></i>
        </div>
        <h2 class="sidebar-title">Coolmate</h2>
    </div>

    <nav class="sidebar-menu">
        <a th:href="@{/admin/home}" class="menu-item ">
            <i class="fas fa-home"></i> <span>Trang chủ</span>
        </a>
        <a th:href="@{/admin/products}" class="menu-item">
            <i class="fas fa-box"></i> <span>Quản lý sản phẩm</span>
        </a>
        <a th:href="@{/admin/categories}" class="menu-item">
            <i class="fas fa-list-alt"></i> <span>Quản lý danh mục</span>
        </a>
        <a th:href="@{/admin/sizes}" class="menu-item">
            <i class="fas fa-ruler-horizontal"></i> <span>Quản lý size</span>
        </a>
        <a th:href="@{/admin/orders}" class="menu-item active">
            <i class="fas fa-shopping-cart"></i> <span>Quản lý đơn hàng</span>
        </a>
        <a th:href="@{/admin/users}" class="menu-item">
            <i class="fas fa-users"></i> <span>Quản lý khách hàng</span>
        </a>
        <a th:href="@{/admin/vouchers}" class="menu-item">
            <i class="fas fa-tag"></i> <span>Quản lý Voucher</span>
        </a>

        <form th:action="@{/logout}" method="post" class="mt-3"
              style="width: 100%; padding: 0;">
            <input type="hidden"
                   th:name="${_csrf.parameterName}"
                   th:value="${_csrf.token}" />

            <button type="submit" class="menu-item"
                    style="width: 100%; border: none; background: transparent;
                           padding: 15px 20px; color: white; cursor: pointer;
                           transition: background 0.2s, border-left 0.2s;
                           font-weight: 500; display: flex; align-items: center;">
                <i class="fas fa-sign-out-alt" style="font-size: 1.1rem; width: 30px; text-align: center;"></i>
                <span>Đăng xuất</span>
            </button>
        </form>
    </nav>
</div>


<div class="main-content">
    <h2 class="mb-4" style="color: #1c3144;">Quản lý Đơn hàng</h2>

    <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show">
        <i class="fas fa-check-circle me-2"></i><span th:text="${successMessage}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show">
        <i class="fas fa-exclamation-triangle me-2"></i><span th:text="${errorMessage}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <div class="card border-0 shadow-sm p-3">
        <div class="d-flex mb-3 gap-2 flex-wrap">
            <a th:href="@{/admin/orders}" class="btn btn-sm" th:classappend="${currentStatus == 'ALL'} ? 'btn-dark' : 'btn-outline-secondary'">Tất cả</a>
            <a th:href="@{/admin/orders(status='PENDING')}" class="btn btn-sm" th:classappend="${currentStatus == 'PENDING'} ? 'btn-warning' : 'btn-outline-warning'">Chờ xử lý</a>
            <a th:href="@{/admin/orders(status='PROCESSING')}" class="btn btn-sm" th:classappend="${currentStatus == 'PROCESSING'} ? 'btn-info text-white' : 'btn-outline-info'">Đang xử lý</a>
            <a th:href="@{/admin/orders(status='SHIPPED')}" class="btn btn-sm" th:classappend="${currentStatus == 'SHIPPED'} ? 'btn-primary' : 'btn-outline-primary'">Đang giao</a>
            <a th:href="@{/admin/orders(status='DELIVERED')}" class="btn btn-sm" th:classappend="${currentStatus == 'DELIVERED'} ? 'btn-success' : 'btn-outline-success'">Hoàn thành</a>
            <a th:href="@{/admin/orders(status='CANCELLED')}" class="btn btn-sm" th:classappend="${currentStatus == 'CANCELLED'} ? 'btn-danger' : 'btn-outline-danger'">Đã hủy</a>
        </div>

        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead class="table-light">
                <tr>
                    <th>Mã đơn</th>
                    <th>Tài khoản đặt</th> <th>Ngày đặt</th>
                    <th>Tổng tiền</th>
                    <th>Thanh toán</th>
                    <th>Trạng thái</th>
                    <th>Địa chỉ giao hàng</th>
                    <th class="text-center">Hành động</th>
                </tr>
                </thead>
                <tbody>
                <tr th:if="${orders.empty}"><td colspan="8" class="text-center py-4">Chưa có đơn hàng nào.</td></tr>
                <tr th:each="o : ${orders}">
                    <td><span class="fw-bold text-dark">#[[${o.id}]]</span></td>
                    <td>
                        <div class="fw-bold" th:text="${o.user != null ? o.user.fullName : 'Khách vãng lai'}"></div>
                        <small class="text-muted" th:text="${o.user != null ? o.user.email : ''}"></small>
                    </td>
                    <td th:text="${#dates.format(o.createdAt, 'dd/MM/yyyy HH:mm')}"></td>

                    <td class="fw-bold text-primary" th:text="${#numbers.formatDecimal(o.finalTotal, 0, 'POINT', 0, 'POINT')} + ' đ'"></td>
                    <td>
                        <span th:text="${o.payment != null ? o.payment.method : 'COD'}"></span>
                        <br>
                        <span class="badge bg-secondary" style="font-size: 0.65rem;" th:if="${o.payment != null && o.payment.status == 'UNPAID'}">Chưa thanh toán</span>
                        <span class="badge bg-success" style="font-size: 0.65rem;" th:if="${o.payment != null && o.payment.status == 'PAID'}">Đã thanh toán</span>
                    </td>
                    <td>
                        <span th:if="${o.status == 'PENDING'}" class="badge badge-status bg-pending">Chờ xử lý</span>
                        <span th:if="${o.status == 'PROCESSING'}" class="badge badge-status bg-processing">Đang xử lý</span>
                        <span th:if="${o.status == 'SHIPPED'}" class="badge badge-status bg-shipped">Đang giao</span>
                        <span th:if="${o.status == 'DELIVERED'}" class="badge badge-status bg-delivered">Hoàn thành</span>
                        <span th:if="${o.status == 'CANCELLED'}" class="badge badge-status bg-cancelled">Đã hủy</span>

                        <span th:if="${o.status != 'PENDING' and o.status != 'PROCESSING' and o.status != 'SHIPPED' and o.status != 'DELIVERED' and o.status != 'CANCELLED'}"
                              class="badge badge-status bg-secondary">
                              [[${o.status}]]
                        </span>
                    </td>
                    <td class="small text-muted" th:text="${o.shippingAddress}">Địa chỉ giao hàng</td>

                    <td class="text-center">
                        <div class="d-flex justify-content-center gap-1">
                            <a th:href="@{/admin/orders(detailId=${o.id})}" class="btn btn-sm btn-outline-primary" title="Xem chi tiết">
                                <i class="fas fa-eye"></i>
                            </a>
                            <div th:if="${o.status != 'DELIVERED' and o.status != 'CANCELLED'}">
                                <form th:action="@{/admin/orders/update-status}" method="post">
                                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                                    <input type="hidden" name="id" th:value="${o.id}">

                                    <input type="hidden" name="status"
                                           th:value="${o.status == 'PENDING' ? 'PROCESSING' : (o.status == 'PROCESSING' ? 'SHIPPED' : (o.status == 'SHIPPED' ? 'DELIVERED' : ''))}">

                                    <button type="submit" class="btn btn-sm btn-dark" title="Cập nhật trạng thái"
                                            th:if="${o.status == 'PENDING' or o.status == 'PROCESSING' or o.status == 'SHIPPED'}">
                                        <i class="fas fa-arrow-right"></i>
                                    </button>
                                </form>
                            </div>
                        </div>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="modal fade" id="orderDetailModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" th:if="${orderDetail != null}">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-light">
                <h5 class="modal-title">
                    Chi tiết Đơn hàng <span class="fw-bold text-primary">#[[${orderDetail.id}]]</span>
                </h5>
                <a th:href="@{/admin/orders}" class="btn-close"></a>
            </div>

            <div class="modal-body">
                <div class="row">
                    <div class="col-md-8">
                        <div class="card mb-3">
                            <div class="card-header bg-white fw-bold">Sản phẩm đã đặt</div>
                            <div class="card-body p-0">
                                <table class="table mb-0 align-middle">
                                    <thead class="bg-light">
                                    <tr>
                                        <th class="ps-3">Sản phẩm</th>
                                        <th>Size</th>
                                        <th class="text-center">SL</th>
                                        <th class="text-end pe-3">Thành tiền</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    <tr th:each="item : ${orderDetail.orderItems}">
                                        <td class="ps-3">
                                            <div class="d-flex align-items-center">
                                                <img th:if="${item.product != null and not #lists.isEmpty(item.product.images)}"
                                                     th:src="${item.product.images[0].imageUrl}"
                                                     class="product-thumb-small">
                                                <div>
                                                    <div class="fw-bold small" th:text="${item.product != null ? item.product.name : 'SP đã xóa'}"></div>
                                                    <small class="text-muted">[[${#numbers.formatDecimal(item.discountPrice, 0, 'POINT', 0, 'POINT')}]]</small>
                                                </div>
                                            </div>
                                        </td>
                                        <td><span class="badge bg-light text-dark border">[[${item.size.sizeName}]]</span></td>
                                        <td class="text-center">x[[${item.quantity}]]</td>
                                        <td class="text-end pe-3 fw-bold">[[${#numbers.formatDecimal(item.discountPrice * item.quantity, 0, 'POINT', 0, 'POINT')}]]</td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="card-footer bg-white text-end">
                                <div class="small">Tạm tính: <span class="fw-bold">[[${#numbers.formatDecimal(orderDetail.total, 0, 'POINT', 0, 'POINT')}]] đ</span></div>
                                <div class="small text-success" th:if="${orderDetail.discountAmount > 0}">
                                    Giảm giá: -[[${#numbers.formatDecimal(orderDetail.discountAmount, 0, 'POINT', 0, 'POINT')}]] đ
                                </div>
                                <h5 class="mt-2 text-primary fw-bold">Tổng cộng: [[${#numbers.formatDecimal(orderDetail.finalTotal, 0, 'POINT', 0, 'POINT')}]] đ</h5>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-4">

                        <div class="card mb-3 border-primary">
                            <div class="card-header bg-primary text-white fw-bold"><i class="fas fa-tasks me-2"></i>Xử lý đơn hàng</div>
                            <div class="card-body">

                                <div th:if="${orderDetail.status != 'DELIVERED' and orderDetail.status != 'CANCELLED'}">
                                    <form th:action="@{/admin/orders/update-status}" method="post" class="mb-3">
                                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                                        <input type="hidden" name="id" th:value="${orderDetail.id}">

                                        <input type="hidden" name="status"
                                               th:value="${orderDetail.status == 'PENDING' ? 'PROCESSING' : (orderDetail.status == 'PROCESSING' ? 'SHIPPED' : (orderDetail.status == 'SHIPPED' ? 'DELIVERED' : ''))}">

                                        <button type="submit" class="btn btn-dark w-100 fw-bold py-2"
                                                th:if="${orderDetail.status != 'DELIVERED' and orderDetail.status != 'CANCELLED'}">
                                            Next: [[${orderDetail.status == 'PENDING' ? 'Đang xử lý' : (orderDetail.status == 'PROCESSING' ? 'Đang giao' : (orderDetail.status == 'SHIPPED' ? 'Hoàn thành' : ''))}]] <i class="fas fa-arrow-right ms-2"></i>
                                        </button>
                                    </form>

                                    <form th:action="@{/admin/orders/update-status}" method="post">
                                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                                        <input type="hidden" name="id" th:value="${orderDetail.id}">
                                        <input type="hidden" name="status" value="CANCELLED">
                                        <button type="submit" class="btn btn-outline-danger w-100 btn-sm"
                                                onclick="return confirm('Xác nhận Hủy đơn hàng #[[${orderDetail.id}]]?');">
                                            <i class="fas fa-times me-1"></i>Hủy đơn hàng
                                        </button>
                                    </form>
                                </div>

                                <div class="alert alert-success mt-3" th:if="${orderDetail.status == 'DELIVERED'}">
                                    <i class="fas fa-check-circle me-2"></i>Đơn hàng đã <strong>Hoàn thành</strong>.
                                </div>
                                <div class="alert alert-danger mt-3" th:if="${orderDetail.status == 'CANCELLED'}">
                                    <i class="fas fa-ban me-2"></i>Đơn hàng đã bị <strong>Hủy</strong>.
                                </div>
                            </div>
                        </div>

                        <div class="card mb-3">
                            <div class="card-header bg-white fw-bold text-muted">
                                <i class="fas fa-user-circle me-2"></i>Tài khoản đặt hàng
                            </div>
                            <div class="card-body">
                                <p class="mb-1 fw-bold" th:text="${orderDetail.user != null ? orderDetail.user.fullName : 'Khách vãng lai'}"></p>
                                <p class="mb-0 small text-muted" th:text="${orderDetail.user != null ? orderDetail.user.email : '---'}"></p>
                            </div>
                        </div>

                        <div class="card mb-3">
                            <div class="card-header bg-white fw-bold text-muted">
                                <i class="fas fa-truck me-2"></i>Địa chỉ nhận hàng
                            </div>
                            <div class="card-body">
                                <p class="mb-1 fw-bold" th:text="${orderDetail.address != null ? orderDetail.address.fullName : '---'}"></p>
                                <p class="mb-1 small text-primary"><i class="fas fa-phone-alt me-1"></i> <span th:text="${orderDetail.address != null ? orderDetail.address.phone : '---'}"></span></p>
                                <p class="mb-0 small text-muted" th:text="${orderDetail.address != null ? orderDetail.address.address : '---'}"></p>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header bg-white fw-bold text-muted">Thanh toán</div>
                            <div class="card-body">
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Hình thức:</span>
                                    <span class="fw-bold" th:text="${orderDetail.payment != null ? orderDetail.payment.method : 'COD'}"></span>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <span>Trạng thái:</span>
                                    <span class="badge bg-success" th:if="${orderDetail.payment != null && orderDetail.payment.status == 'PAID'}">Đã thanh toán</span>
                                    <span class="badge bg-secondary" th:if="${orderDetail.payment == null || orderDetail.payment.status == 'UNPAID'}">Chưa thanh toán</span>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
            <div class="modal-footer bg-light">
                <a th:href="@{/admin/orders}" class="btn btn-secondary">Đóng</a>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script th:if="${showModal}">
    document.addEventListener("DOMContentLoaded", function() {
        new bootstrap.Modal(document.getElementById('orderDetailModal')).show();
    });
</script>
<script>
    setTimeout(function() {
        let alerts = document.querySelectorAll('.alert');
        alerts.forEach(alert => {
            alert.classList.remove('show');
            setTimeout(() => alert.remove(), 500);
        });
    }, 4000);

    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        const mainContent = document.getElementById('mainContent');
        const toggleIcon = document.getElementById('toggleIcon');

        sidebar.classList.toggle('collapsed');
        mainContent.classList.toggle('expanded');

        if (sidebar.classList.contains('collapsed')) {
            toggleIcon.classList.remove('fa-chevron-left');
            toggleIcon.classList.add('fa-chevron-right');
        } else {
            toggleIcon.classList.remove('fa-chevron-right');
            toggleIcon.classList.add('fa-chevron-left');
        }
    }
</script>
</body>
</html>